# Database Migration Strategy

## Fresh Start for Alpha/POC Phase

This project uses Alembic for database schema management. During the alpha/POC phase, we're using a fresh start strategy for migrations.

### Why Fresh Start?

1. **Alpha/POC Phase**: The project is in early development, allowing complete schema replacement
2. **Clean Architecture**: Moving from mixed models to pure Phenopackets v2 standard
3. **No Production Data**: No existing production data to preserve

### Migration Commands

```bash
# Check current migration status
uv run alembic current

# Apply all migrations (create/update schema)
uv run alembic upgrade head

# View migration history
uv run alembic history

# Downgrade (if needed)
uv run alembic downgrade -1

# Create new migration (autogenerate)
uv run alembic revision --autogenerate -m "Description of changes"

# Create new migration (manual)
uv run alembic revision -m "Description of changes"
```

### Initial Setup

The initial migration (`001_initial_v2`) creates the complete Phenopackets v2 schema:

- **phenopackets**: Core phenopacket storage with JSONB
- **families**: Family relationships
- **cohorts**: Study cohorts
- **resources**: Ontology resources (HPO, MONDO, LOINC)
- **phenopacket_audit**: Change tracking

### Important Notes

1. **No create_all**: The application no longer uses `Base.metadata.create_all()`. All schema management is through Alembic.

2. **Environment Variables**: Ensure `DATABASE_URL` is set in your `.env` file:
   ```
   DATABASE_URL=postgresql+asyncpg://hnf1b_user:hnf1b_pass@localhost:5433/hnf1b_phenopackets
   ```

3. **Fresh Database**: For a completely fresh start:
   ```bash
   # Drop all tables (CAUTION: destroys all data)
   uv run python -c "
   import asyncio
   from sqlalchemy import text
   from app.database import engine

   async def drop_all():
       async with engine.begin() as conn:
           await conn.execute(text('DROP SCHEMA public CASCADE'))
           await conn.execute(text('CREATE SCHEMA public'))

   asyncio.run(drop_all())
   "

   # Apply migrations
   uv run alembic upgrade head
   ```

### Migration Best Practices

1. Always review autogenerated migrations before applying
2. Test migrations in development before production
3. Keep migrations small and focused
4. Document breaking changes in migration files
5. Use descriptive migration messages