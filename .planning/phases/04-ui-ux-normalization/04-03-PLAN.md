---
phase: 04-ui-ux-normalization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/components/common/DataTableToolbar.vue
autonomous: true

must_haves:
  truths:
    - "DataTableToolbar provides comprehensive toolbar for data table views"
    - "DataTableToolbar includes search, filter chips, result count, and action slots"
    - "DataTableToolbar is responsive with proper mobile collapse"
    - "DataTableToolbar debounces search input"
  artifacts:
    - path: "frontend/src/components/common/DataTableToolbar.vue"
      provides: "Enhanced data table toolbar component"
      min_lines: 100
      contains: "debounce"
  key_links:
    - from: "frontend/src/components/common/DataTableToolbar.vue"
      to: "Vuetify components"
      via: "v-text-field, v-chip, v-btn, v-menu"
      pattern: "v-text-field|v-chip|v-btn|v-menu"
---

<objective>
Create reusable DataTableToolbar.vue component for enhanced data table controls.

Purpose: Provide comprehensive toolbar with search, active filter display, result count, column settings, and export actions. Enhances existing AppTableToolbar pattern with additional features per CONTEXT.md requirements.

Output: DataTableToolbar.vue component with search, filter chips, result count, column visibility menu, and action slots.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ui-ux-normalization/04-CONTEXT.md
@.planning/phases/04-ui-ux-normalization/04-RESEARCH.md
@frontend/src/components/common/AppTableToolbar.vue
@frontend/src/views/Phenopackets.vue
@frontend/src/views/Variants.vue
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create DataTableToolbar.vue component</name>
  <files>frontend/src/components/common/DataTableToolbar.vue</files>
  <action>
Create `frontend/src/components/common/DataTableToolbar.vue` as an enhanced version of AppTableToolbar:

**Template:**
```vue
<template>
  <div class="data-table-toolbar">
    <!-- Primary Row: Search + Result Count + Actions -->
    <div class="toolbar-row d-flex align-center ga-3 flex-wrap">
      <!-- Search Input -->
      <v-text-field
        :model-value="searchQuery"
        :placeholder="searchPlaceholder"
        prepend-inner-icon="mdi-magnify"
        clearable
        :loading="loading"
        hide-details
        variant="outlined"
        density="compact"
        class="search-field"
        style="max-width: 400px; min-width: 200px"
        @update:model-value="onSearchInput"
        @click:clear="onClearSearch"
        @keyup.enter="onSearchSubmit"
      />

      <v-spacer />

      <!-- Results count -->
      <v-chip
        v-if="showResultCount"
        color="teal"
        size="small"
        variant="tonal"
        class="result-chip"
      >
        <v-icon start size="x-small">mdi-database</v-icon>
        {{ resultCount.toLocaleString() }} {{ resultLabel }}
      </v-chip>

      <!-- Column visibility menu (optional) -->
      <v-menu v-if="showColumnSettings && columns.length" location="bottom end">
        <template #activator="{ props }">
          <v-btn
            v-bind="props"
            icon="mdi-table-column"
            variant="text"
            size="small"
            aria-label="Column settings"
          />
        </template>
        <v-card min-width="200">
          <v-card-title class="text-subtitle-2">Visible Columns</v-card-title>
          <v-card-text class="py-0">
            <v-checkbox
              v-for="col in columns"
              :key="col.key"
              :model-value="col.visible"
              :label="col.title"
              density="compact"
              hide-details
              class="my-1"
              @update:model-value="$emit('column-toggle', col.key, $event)"
            />
          </v-card-text>
        </v-card>
      </v-menu>

      <!-- Actions slot (export, add button, etc.) -->
      <slot name="actions" />
    </div>

    <!-- Active Filters Row (if any active filters) -->
    <div v-if="hasActiveFilters" class="filter-row d-flex align-center ga-2 mt-2 flex-wrap">
      <span class="text-caption text-medium-emphasis">Active filters:</span>

      <!-- Search query chip -->
      <v-chip
        v-if="searchQuery"
        closable
        color="primary"
        size="small"
        variant="flat"
        @click:close="onClearSearch"
      >
        <v-icon start size="x-small">mdi-magnify</v-icon>
        "{{ truncateText(searchQuery, 20) }}"
      </v-chip>

      <!-- Filter chips from prop -->
      <v-chip
        v-for="filter in activeFilters"
        :key="filter.key"
        closable
        :color="filter.color || 'secondary'"
        size="small"
        variant="flat"
        @click:close="$emit('remove-filter', filter.key)"
      >
        <v-icon v-if="filter.icon" start size="x-small">{{ filter.icon }}</v-icon>
        {{ filter.label }}
      </v-chip>

      <!-- Clear all button -->
      <v-btn
        v-if="activeFilters.length > 0 || searchQuery"
        variant="text"
        size="x-small"
        color="warning"
        @click="onClearAll"
      >
        Clear All
      </v-btn>
    </div>
  </div>
</template>
```

**Script:**
```javascript
import debounce from 'just-debounce-it';

export default {
  name: 'DataTableToolbar',
  props: {
    searchQuery: { type: String, default: '' },
    searchPlaceholder: { type: String, default: 'Search...' },
    resultCount: { type: Number, default: 0 },
    resultLabel: { type: String, default: 'results' },
    showResultCount: { type: Boolean, default: true },
    loading: { type: Boolean, default: false },
    debounceDelay: { type: Number, default: 300 },
    activeFilters: { type: Array, default: () => [] },
    columns: { type: Array, default: () => [] },
    showColumnSettings: { type: Boolean, default: false },
  },
  emits: [
    'update:searchQuery',
    'search',
    'clear-search',
    'remove-filter',
    'clear-all-filters',
    'column-toggle',
  ],
  computed: {
    hasActiveFilters() {
      return this.searchQuery || this.activeFilters.length > 0;
    },
  },
  created() {
    this.debouncedSearch = debounce((value) => {
      this.$emit('search', value);
    }, this.debounceDelay);
  },
  methods: {
    truncateText(text, maxLength) {
      if (!text || text.length <= maxLength) return text;
      return text.substring(0, maxLength) + '...';
    },
    onSearchInput(value) {
      this.$emit('update:searchQuery', value);
      this.debouncedSearch(value);
    },
    onSearchSubmit() {
      this.$emit('search', this.searchQuery);
    },
    onClearSearch() {
      this.$emit('update:searchQuery', '');
      this.$emit('clear-search');
    },
    onClearAll() {
      this.onClearSearch();
      this.$emit('clear-all-filters');
    },
  },
};
```

**Scoped Styles:**
```css
.data-table-toolbar {
  padding: 12px 16px;
  background-color: rgba(var(--v-theme-on-surface), 0.02);
  border-bottom: 1px solid rgba(0, 0, 0, 0.08);
}

.toolbar-row {
  min-height: 40px;
}

.search-field :deep(.v-field) {
  font-size: 0.9rem;
}

.search-field :deep(.v-field__input) {
  padding-top: 8px;
  padding-bottom: 8px;
  min-height: 40px;
}

.result-chip {
  font-size: 0.8125rem;
  font-weight: 500;
}

.filter-row {
  padding-top: 4px;
}

/* Responsive: Stack on mobile */
@media (max-width: 600px) {
  .search-field {
    min-width: 100% !important;
    max-width: 100% !important;
  }

  .toolbar-row {
    flex-direction: column;
    align-items: stretch !important;
    gap: 8px !important;
  }
}
```

**Notes:**
- Uses Options API per project convention
- Imports `just-debounce-it` (already a project dependency)
- Filter chips use `activeFilters` prop format: `[{ key: 'sex', label: 'Male', icon: 'mdi-gender-male', color: 'blue' }]`
- Column visibility uses `columns` prop format: `[{ key: 'name', title: 'Name', visible: true }]`
  </action>
  <verify>
    File exists at frontend/src/components/common/DataTableToolbar.vue
    `grep "debounce" frontend/src/components/common/DataTableToolbar.vue` finds debounce import
    `grep "column-toggle" frontend/src/components/common/DataTableToolbar.vue` finds column toggle emit
    `cd frontend && npm run build 2>&1 | head -20` compiles without errors
  </verify>
  <done>
    DataTableToolbar.vue created with search, filter chips, result count, column settings, and responsive design
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for DataTableToolbar</name>
  <files>frontend/tests/components/DataTableToolbar.test.js</files>
  <action>
Create `frontend/tests/components/DataTableToolbar.test.js` with comprehensive tests:

```javascript
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { mount } from '@vue/test-utils';
import { createVuetify } from 'vuetify';
import * as components from 'vuetify/components';
import * as directives from 'vuetify/directives';
import DataTableToolbar from '@/components/common/DataTableToolbar.vue';

const vuetify = createVuetify({ components, directives });

function mountToolbar(props = {}, slots = {}) {
  return mount(DataTableToolbar, {
    props,
    slots,
    global: {
      plugins: [vuetify],
    },
  });
}

describe('DataTableToolbar', () => {
  beforeEach(() => {
    vi.useFakeTimers();
  });

  afterEach(() => {
    vi.useRealTimers();
  });

  describe('search functionality', () => {
    it('renders search input with placeholder', () => {
      const wrapper = mountToolbar({ searchPlaceholder: 'Search items...' });
      const input = wrapper.find('input');
      expect(input.attributes('placeholder')).toBe('Search items...');
    });

    it('emits update:searchQuery on input', async () => {
      const wrapper = mountToolbar();
      const input = wrapper.find('input');
      await input.setValue('test query');
      expect(wrapper.emitted('update:searchQuery')[0]).toEqual(['test query']);
    });

    it('debounces search event', async () => {
      const wrapper = mountToolbar({ debounceDelay: 300 });
      const input = wrapper.find('input');
      await input.setValue('test');

      // Search not emitted immediately
      expect(wrapper.emitted('search')).toBeUndefined();

      // Advance timers
      vi.advanceTimersByTime(300);

      // Now search should be emitted
      expect(wrapper.emitted('search')?.[0]).toEqual(['test']);
    });

    it('emits search immediately on Enter', async () => {
      const wrapper = mountToolbar({ searchQuery: 'query' });
      const input = wrapper.find('input');
      await input.trigger('keyup.enter');
      expect(wrapper.emitted('search')?.[0]).toEqual(['query']);
    });

    it('emits clear-search when cleared', async () => {
      const wrapper = mountToolbar({ searchQuery: 'test' });
      // Trigger clear via method (simulating clear button)
      wrapper.vm.onClearSearch();
      expect(wrapper.emitted('update:searchQuery')[0]).toEqual(['']);
      expect(wrapper.emitted('clear-search')).toHaveLength(1);
    });
  });

  describe('result count', () => {
    it('shows result count when showResultCount is true', () => {
      const wrapper = mountToolbar({ resultCount: 42, showResultCount: true });
      expect(wrapper.text()).toContain('42');
    });

    it('hides result count when showResultCount is false', () => {
      const wrapper = mountToolbar({ resultCount: 42, showResultCount: false });
      expect(wrapper.find('.result-chip').exists()).toBe(false);
    });

    it('formats large result counts with locale', () => {
      const wrapper = mountToolbar({ resultCount: 1234567 });
      expect(wrapper.text()).toContain('1,234,567');
    });

    it('uses custom result label', () => {
      const wrapper = mountToolbar({ resultCount: 5, resultLabel: 'variants' });
      expect(wrapper.text()).toContain('5 variants');
    });
  });

  describe('active filters', () => {
    it('shows active filters row when filters exist', () => {
      const filters = [{ key: 'sex', label: 'Male' }];
      const wrapper = mountToolbar({ activeFilters: filters });
      expect(wrapper.find('.filter-row').exists()).toBe(true);
    });

    it('shows search query as filter chip', () => {
      const wrapper = mountToolbar({ searchQuery: 'test query' });
      expect(wrapper.text()).toContain('"test query"');
    });

    it('emits remove-filter when filter chip closed', async () => {
      const filters = [{ key: 'sex', label: 'Male' }];
      const wrapper = mountToolbar({ activeFilters: filters });

      // Find the closable chip and trigger close
      const chips = wrapper.findAllComponents({ name: 'v-chip' });
      const filterChip = chips.find(c => c.text().includes('Male'));
      await filterChip.vm.$emit('click:close');

      expect(wrapper.emitted('remove-filter')?.[0]).toEqual(['sex']);
    });

    it('emits clear-all-filters when Clear All clicked', async () => {
      const filters = [{ key: 'sex', label: 'Male' }];
      const wrapper = mountToolbar({ activeFilters: filters });

      const clearBtn = wrapper.findAll('button').find(b => b.text().includes('Clear All'));
      await clearBtn.trigger('click');

      expect(wrapper.emitted('clear-all-filters')).toHaveLength(1);
    });

    it('truncates long search queries in chip', () => {
      const wrapper = mountToolbar({ searchQuery: 'this is a very long search query that should be truncated' });
      expect(wrapper.text()).toContain('...');
    });
  });

  describe('column settings', () => {
    const columns = [
      { key: 'name', title: 'Name', visible: true },
      { key: 'age', title: 'Age', visible: false },
    ];

    it('shows column settings button when enabled', () => {
      const wrapper = mountToolbar({ showColumnSettings: true, columns });
      expect(wrapper.find('button[aria-label="Column settings"]').exists()).toBe(true);
    });

    it('hides column settings button when disabled', () => {
      const wrapper = mountToolbar({ showColumnSettings: false, columns });
      expect(wrapper.find('button[aria-label="Column settings"]').exists()).toBe(false);
    });
  });

  describe('actions slot', () => {
    it('renders actions slot content', () => {
      const wrapper = mountToolbar({}, { actions: '<button id="export">Export</button>' });
      expect(wrapper.find('#export').exists()).toBe(true);
    });
  });

  describe('loading state', () => {
    it('shows loading indicator when loading', () => {
      const wrapper = mountToolbar({ loading: true });
      expect(wrapper.find('.v-text-field--loading').exists()).toBe(true);
    });
  });
});
```
  </action>
  <verify>
    File exists at frontend/tests/components/DataTableToolbar.test.js
    `cd frontend && npm test -- tests/components/DataTableToolbar.test.js 2>&1 | grep -E "(PASS|FAIL|Tests:)"` shows tests passing
  </verify>
  <done>
    Unit tests pass for DataTableToolbar covering search, filters, column settings, and actions
  </done>
</task>

</tasks>

<verification>
1. DataTableToolbar.vue file exists in frontend/src/components/common/
2. Component includes search, filter chips, result count, column settings menu
3. Debounce logic implemented correctly
4. Responsive design with mobile breakpoint
5. All unit tests pass
6. Frontend builds without errors: `cd frontend && npm run build`
7. Frontend tests pass: `cd frontend && npm test`
</verification>

<success_criteria>
- DataTableToolbar.vue created with enhanced toolbar features
- Props: searchQuery, searchPlaceholder, resultCount, resultLabel, showResultCount, loading, debounceDelay, activeFilters, columns, showColumnSettings
- Emits: update:searchQuery, search, clear-search, remove-filter, clear-all-filters, column-toggle
- Slots: actions
- Active filter chips display with close buttons
- Column visibility menu (optional)
- Responsive: stacks on mobile
- Unit tests cover all props, emits, and features
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-ux-normalization/04-03-SUMMARY.md`
</output>
