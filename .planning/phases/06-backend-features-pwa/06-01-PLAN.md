---
phase: 06-backend-features-pwa
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/auth/dependencies.py
  - backend/app/utils/audit_logger.py
  - backend/app/phenopackets/routers/aggregations/common.py
  - backend/app/phenopackets/routers/aggregations/summary.py
  - backend/app/phenopackets/routers/aggregations/features.py
  - backend/app/phenopackets/routers/aggregations/diseases.py
  - backend/app/phenopackets/routers/aggregations/demographics.py
  - backend/app/phenopackets/routers/aggregations/variants.py
  - backend/app/phenopackets/routers/aggregations/publications.py
  - backend/app/phenopackets/routers/aggregations/all_variants.py
  - backend/app/phenopackets/routers/aggregations/survival.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Aggregation endpoints accept optional Authorization header"
    - "Authenticated requests log user_id to audit log"
    - "Unauthenticated requests do NOT log (per CONTEXT.md - anonymous not tracked)"
    - "Existing endpoint functionality unchanged"
    - "All backend tests pass"
  artifacts:
    - path: "backend/app/auth/dependencies.py"
      provides: "get_current_user_optional dependency"
      contains: "get_current_user_optional"
    - path: "backend/app/utils/audit_logger.py"
      provides: "log_aggregation_access function"
      contains: "log_aggregation_access"
  key_links:
    - from: "backend/app/phenopackets/routers/aggregations/*.py"
      to: "backend/app/auth/dependencies.py"
      via: "Depends(get_current_user_optional)"
      pattern: "get_current_user_optional"
    - from: "backend/app/phenopackets/routers/aggregations/*.py"
      to: "backend/app/utils/audit_logger.py"
      via: "log_aggregation_access call"
      pattern: "log_aggregation_access"
---

<objective>
Add optional user tracking to all aggregation endpoints for authenticated users.

Purpose: Enable audit logging of which authenticated users access aggregation endpoints for GDPR compliance and usage analytics, without breaking public access or tracking anonymous users.

Output: All aggregation endpoints accept optional auth, log user_id for authenticated requests, skip tracking for unauthenticated requests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-features-pwa/06-CONTEXT.md
@.planning/phases/06-backend-features-pwa/06-RESEARCH.md
@backend/app/auth/dependencies.py
@backend/app/utils/audit_logger.py
@backend/app/phenopackets/routers/aggregations/common.py
@backend/app/phenopackets/routers/aggregations/summary.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create optional auth dependency and audit logging function</name>
  <files>
    backend/app/auth/dependencies.py
    backend/app/utils/audit_logger.py
  </files>
  <action>
1. In `backend/app/auth/dependencies.py`:
   - Add `Optional` import from typing
   - Create `optional_security = HTTPBearer(auto_error=False)` at module level
   - Add `get_current_user_optional` async function that:
     - Takes `credentials: Optional[HTTPAuthorizationCredentials] = Depends(optional_security)`
     - Takes `db: AsyncSession = Depends(get_db)`
     - Returns `Optional[User]`
     - Returns `None` if credentials is None (no token provided)
     - Returns `None` if any error during token verification (invalid/expired token)
     - Returns the User if token is valid and user is active
     - Does NOT raise HTTPException (unlike get_current_user)
   - Reuse existing `verify_token` function for token validation

2. In `backend/app/utils/audit_logger.py`:
   - Add `log_aggregation_access` function that:
     - Takes `user_id: int`, `endpoint: str`, `timestamp: datetime`
     - Creates structured log entry with event="AGGREGATION_ACCESS"
     - Logs timestamp in ISO format with Z suffix
     - Uses `audit_logger.info()` to log
   - Only logs user_id (integer), NOT email or PII (GDPR compliance)
   - Document that this function is only called for authenticated users
  </action>
  <verify>
    - `cd /home/bernt-popp/development/hnf1b-db/backend && uv run python -c "from app.auth.dependencies import get_current_user_optional; print('Import OK')"`
    - `cd /home/bernt-popp/development/hnf1b-db/backend && uv run python -c "from app.utils.audit_logger import log_aggregation_access; print('Import OK')"`
    - `cd /home/bernt-popp/development/hnf1b-db/backend && make typecheck`
  </verify>
  <done>
    - get_current_user_optional returns Optional[User], never raises 401
    - log_aggregation_access logs structured AGGREGATION_ACCESS events
    - Type checking passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add optional user tracking to all aggregation endpoints</name>
  <files>
    backend/app/phenopackets/routers/aggregations/common.py
    backend/app/phenopackets/routers/aggregations/summary.py
    backend/app/phenopackets/routers/aggregations/features.py
    backend/app/phenopackets/routers/aggregations/diseases.py
    backend/app/phenopackets/routers/aggregations/demographics.py
    backend/app/phenopackets/routers/aggregations/variants.py
    backend/app/phenopackets/routers/aggregations/publications.py
    backend/app/phenopackets/routers/aggregations/all_variants.py
    backend/app/phenopackets/routers/aggregations/survival.py
  </files>
  <action>
1. In `backend/app/phenopackets/routers/aggregations/common.py`:
   - Add import: `from app.auth.dependencies import get_current_user_optional`
   - Add import: `from app.utils.audit_logger import log_aggregation_access`
   - Add import: `from app.models.user import User`
   - Add import: `from datetime import datetime, timezone`
   - Re-export these in the `from .common import` pattern used by other modules

2. In each aggregation module (summary.py, features.py, diseases.py, demographics.py, variants.py, publications.py, all_variants.py, survival.py):
   - Update imports from common.py to include new dependencies
   - For EACH endpoint function:
     a. Add parameter: `current_user: Optional[User] = Depends(get_current_user_optional)`
     b. At the START of the function (before any DB queries), add:
        ```python
        if current_user:
            log_aggregation_access(
                user_id=current_user.id,
                endpoint="/aggregate/{endpoint_path}",
                timestamp=datetime.now(timezone.utc),
            )
        ```
     c. Use the actual endpoint path for each endpoint (e.g., "/aggregate/summary", "/aggregate/features", etc.)

3. Pattern for each file - example for summary.py:
   ```python
   from .common import (
       # existing imports...
       get_current_user_optional,
       log_aggregation_access,
       User,
       datetime,
       timezone,
   )

   @router.get("/summary", response_model=Dict[str, int])
   async def get_summary_statistics(
       db: AsyncSession = Depends(get_db),
       current_user: Optional[User] = Depends(get_current_user_optional),
   ):
       if current_user:
           log_aggregation_access(
               user_id=current_user.id,
               endpoint="/aggregate/summary",
               timestamp=datetime.now(timezone.utc),
           )
       # ... rest of existing logic unchanged ...
   ```

4. Count of endpoints to update:
   - summary.py: 1 endpoint (get_summary_statistics)
   - features.py: multiple endpoints (check file)
   - diseases.py: multiple endpoints
   - demographics.py: multiple endpoints
   - variants.py: multiple endpoints
   - publications.py: multiple endpoints
   - all_variants.py: 1 main endpoint
   - survival.py: multiple endpoints
  </action>
  <verify>
    - `cd /home/bernt-popp/development/hnf1b-db/backend && make lint`
    - `cd /home/bernt-popp/development/hnf1b-db/backend && make typecheck`
    - `cd /home/bernt-popp/development/hnf1b-db/backend && make test`
    - Test unauthenticated: `curl -s http://localhost:8000/api/v2/phenopackets/aggregate/summary | head -c 200`
    - Backend logs should NOT show AGGREGATION_ACCESS for unauthenticated request
  </verify>
  <done>
    - All aggregation endpoints have optional user parameter
    - Authenticated requests log to audit trail
    - Unauthenticated requests work without logging
    - All 768+ backend tests pass
    - Linting and type checking pass
  </done>
</task>

</tasks>

<verification>
1. Backend quality gates:
   - `cd backend && make check` passes (lint + typecheck + test)
2. Endpoint functionality preserved:
   - All aggregation endpoints return same data as before
   - No 401 errors for public access
3. Tracking works when authenticated:
   - Login, get JWT token
   - Call aggregation endpoint with Authorization header
   - Check backend logs for AGGREGATION_ACCESS entry
</verification>

<success_criteria>
- get_current_user_optional dependency created and returns Optional[User]
- log_aggregation_access function created and logs to audit logger
- All aggregation endpoints have optional user tracking
- Unauthenticated requests work without any tracking
- Authenticated requests log user_id (not email) to audit trail
- All backend tests pass (768+)
- Linting and type checking pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-features-pwa/06-01-SUMMARY.md`
</output>
