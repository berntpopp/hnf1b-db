---
phase: 06-backend-features-pwa
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/package.json
  - frontend/vite.config.js
  - frontend/public/offline.html
  - frontend/public/pwa-192x192.png
  - frontend/public/pwa-512x512.png
autonomous: true
user_setup: []

must_haves:
  truths:
    - "PWA install prompt appears in supported browsers"
    - "Service worker registers on page load"
    - "Offline page shows when network unavailable"
    - "Structure file (2h8r.cif) loads from cache when offline"
    - "Static assets cached for offline access"
  artifacts:
    - path: "frontend/vite.config.js"
      provides: "VitePWA plugin configuration"
      contains: "VitePWA"
    - path: "frontend/public/offline.html"
      provides: "Offline fallback page"
      contains: "You're Offline"
    - path: "frontend/public/pwa-192x192.png"
      provides: "PWA icon 192x192"
    - path: "frontend/public/pwa-512x512.png"
      provides: "PWA icon 512x512"
  key_links:
    - from: "frontend/vite.config.js"
      to: "frontend/public/offline.html"
      via: "navigateFallback config"
      pattern: "navigateFallback.*offline.html"
    - from: "frontend/vite.config.js"
      to: "workbox runtimeCaching"
      via: "2h8r.cif CacheFirst strategy"
      pattern: "2h8r\\.cif.*CacheFirst"
---

<objective>
Add Progressive Web App (PWA) capabilities with service worker caching for offline support.

Purpose: Enable offline viewing of cached data and the 3D structure viewer. Provide native app-like install experience.

Output: PWA-enabled frontend with service worker caching, offline fallback, and app manifest.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-features-pwa/06-CONTEXT.md
@.planning/phases/06-backend-features-pwa/06-RESEARCH.md
@frontend/vite.config.js
@frontend/package.json
@frontend/src/utils/designTokens.js
@frontend/public/HNF1B-db_logo.svg
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vite-plugin-pwa and generate PWA icons</name>
  <files>
    frontend/package.json
    frontend/public/pwa-192x192.png
    frontend/public/pwa-512x512.png
  </files>
  <action>
1. Install vite-plugin-pwa as dev dependency:
   ```bash
   cd /home/bernt-popp/development/hnf1b-db/frontend && npm install vite-plugin-pwa -D
   ```

2. Generate PWA icons from existing SVG logo:
   - Source: `frontend/public/HNF1B-db_logo.svg`
   - Use sharp (install temporarily) or imagemagick/inkscape to convert:
   ```bash
   # Option A: Using sharp (Node.js)
   cd /home/bernt-popp/development/hnf1b-db/frontend
   npm install sharp --save-dev
   node -e "
   const sharp = require('sharp');
   sharp('public/HNF1B-db_logo.svg')
     .resize(192, 192)
     .png()
     .toFile('public/pwa-192x192.png');
   sharp('public/HNF1B-db_logo.svg')
     .resize(512, 512)
     .png()
     .toFile('public/pwa-512x512.png');
   "
   # Then uninstall sharp: npm uninstall sharp

   # Option B: Using inkscape (if available)
   inkscape -w 192 -h 192 public/HNF1B-db_logo.svg -o public/pwa-192x192.png
   inkscape -w 512 -h 512 public/HNF1B-db_logo.svg -o public/pwa-512x512.png

   # Option C: Using ImageMagick convert
   convert -background none -resize 192x192 public/HNF1B-db_logo.svg public/pwa-192x192.png
   convert -background none -resize 512x512 public/HNF1B-db_logo.svg public/pwa-512x512.png
   ```

3. Verify icons exist and have correct dimensions:
   ```bash
   ls -la frontend/public/pwa-*.png
   file frontend/public/pwa-192x192.png
   file frontend/public/pwa-512x512.png
   ```
  </action>
  <verify>
    - `ls -la /home/bernt-popp/development/hnf1b-db/frontend/public/pwa-*.png` shows both files
    - `grep vite-plugin-pwa /home/bernt-popp/development/hnf1b-db/frontend/package.json` shows dependency
  </verify>
  <done>
    - vite-plugin-pwa added to devDependencies
    - pwa-192x192.png exists (192x192 pixels)
    - pwa-512x512.png exists (512x512 pixels)
  </done>
</task>

<task type="auto">
  <name>Task 2: Configure VitePWA plugin and create offline page</name>
  <files>
    frontend/vite.config.js
    frontend/public/offline.html
  </files>
  <action>
1. Create `frontend/public/offline.html`:
   - Use design tokens colors: #009688 (teal primary), #F5F7FA (background)
   - Simple centered layout with:
     - "You're Offline" heading
     - "Please reconnect to continue using HNF1B-DB." message
     - "Retry" button that calls `location.reload()`
   - Roboto font family for consistency
   - Minimal CSS (no external dependencies)

2. Update `frontend/vite.config.js`:
   - Add import: `import { VitePWA } from 'vite-plugin-pwa';`
   - Add VitePWA plugin to plugins array with this configuration:

   ```javascript
   VitePWA({
     registerType: 'autoUpdate',
     includeAssets: ['favicon.ico', '2h8r.cif', 'offline.html'],
     manifest: {
       name: 'HNF1B Database',
       short_name: 'HNF1B-DB',
       description: 'Clinical and genetic data for HNF1B-related disorders',
       theme_color: '#009688',
       background_color: '#F5F7FA',
       display: 'standalone',
       icons: [
         {
           src: 'pwa-192x192.png',
           sizes: '192x192',
           type: 'image/png',
         },
         {
           src: 'pwa-512x512.png',
           sizes: '512x512',
           type: 'image/png',
         },
         {
           src: 'pwa-512x512.png',
           sizes: '512x512',
           type: 'image/png',
           purpose: 'maskable',
         },
       ],
     },
     workbox: {
       globPatterns: ['**/*.{js,css,html,ico,png,svg,woff2}'],
       runtimeCaching: [
         {
           // Structure file: CacheFirst (rarely changes, 30-day expiry)
           urlPattern: /\/2h8r\.cif$/,
           handler: 'CacheFirst',
           options: {
             cacheName: 'structure-files',
             expiration: {
               maxEntries: 1,
               maxAgeSeconds: 60 * 60 * 24 * 30,
             },
           },
         },
         {
           // API responses: NetworkFirst (fresh data when online, cached fallback)
           urlPattern: /\/api\/v2\/.*/,
           handler: 'NetworkFirst',
           options: {
             cacheName: 'api-cache',
             networkTimeoutSeconds: 10,
             expiration: {
               maxEntries: 50,
               maxAgeSeconds: 60 * 60,
             },
             cacheableResponse: {
               statuses: [0, 200],
             },
           },
         },
       ],
       navigateFallback: '/offline.html',
       navigateFallbackDenylist: [/^\/api\//],
     },
   })
   ```

3. Key configuration notes:
   - `registerType: 'autoUpdate'` - automatically update service worker
   - `includeAssets` - files to precache besides glob patterns
   - `2h8r.cif` CacheFirst - always serve from cache, update in background
   - API NetworkFirst - try network first, fall back to cache
   - `navigateFallbackDenylist` - don't serve offline.html for API routes
  </action>
  <verify>
    - `cat /home/bernt-popp/development/hnf1b-db/frontend/public/offline.html` shows offline page
    - `grep -A5 VitePWA /home/bernt-popp/development/hnf1b-db/frontend/vite.config.js` shows plugin config
    - `cd /home/bernt-popp/development/hnf1b-db/frontend && npm run build` completes successfully
    - `ls /home/bernt-popp/development/hnf1b-db/frontend/dist/sw.js` shows service worker generated
  </verify>
  <done>
    - offline.html created with teal/grey theme
    - VitePWA plugin configured in vite.config.js
    - Build produces sw.js service worker
    - Build produces manifest.webmanifest
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify PWA and run frontend tests</name>
  <files>
    (no files modified - verification only)
  </files>
  <action>
1. Run frontend linting:
   ```bash
   cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint
   ```

2. Run frontend tests:
   ```bash
   cd /home/bernt-popp/development/hnf1b-db/frontend && npm test
   ```

3. Build and verify PWA artifacts:
   ```bash
   cd /home/bernt-popp/development/hnf1b-db/frontend && npm run build
   ls -la dist/sw.js dist/manifest.webmanifest dist/offline.html
   ```

4. Check manifest content:
   ```bash
   cat /home/bernt-popp/development/hnf1b-db/frontend/dist/manifest.webmanifest | head -20
   ```

5. Verify no console errors in dev mode:
   - Start dev server: `npm run dev`
   - Open http://localhost:5173 in browser
   - Check DevTools > Application > Service Workers tab
   - Service worker should be "activated and running" (in production build)
  </action>
  <verify>
    - `cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint` passes
    - `cd /home/bernt-popp/development/hnf1b-db/frontend && npm test` passes (487+ tests)
    - `ls /home/bernt-popp/development/hnf1b-db/frontend/dist/manifest.webmanifest` exists after build
  </verify>
  <done>
    - Frontend linting passes
    - All 487+ frontend tests pass
    - PWA manifest generated correctly
    - Service worker generated in build
  </done>
</task>

</tasks>

<verification>
1. Frontend quality gates:
   - `cd frontend && make check` passes (test + lint + format)
2. PWA build artifacts:
   - dist/sw.js exists
   - dist/manifest.webmanifest exists with correct name/icons
   - dist/offline.html exists
3. Manual verification (optional):
   - Build: `npm run build`
   - Preview: `npm run preview`
   - Open in Chrome, check DevTools > Application > Service Workers
   - Lighthouse PWA audit passes installability requirements
</verification>

<success_criteria>
- vite-plugin-pwa installed as devDependency
- PWA icons (192x192, 512x512) generated from SVG logo
- VitePWA configured with:
  - App manifest (name, icons, theme color)
  - Service worker with workbox caching
  - CacheFirst for 2h8r.cif structure file
  - NetworkFirst for API responses
  - Offline fallback page
- offline.html created with HNF1B-DB branding
- Build produces service worker and manifest
- All 487+ frontend tests pass
- Linting passes
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-features-pwa/06-02-SUMMARY.md`
</output>
