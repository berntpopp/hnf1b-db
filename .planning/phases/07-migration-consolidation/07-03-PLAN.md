---
phase: 07-migration-consolidation
plan: 03
type: execute
wave: 2
depends_on: ["07-01", "07-02"]
files_modified:
  - backend/alembic/versions/*.py
  - docs/MIGRATION_CONSOLIDATION.md
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Fresh database can be created with single migration"
    - "Schema from consolidated migration matches original schema exactly"
    - "Old migrations are removed from codebase"
    - "Production migration procedure is documented"
  artifacts:
    - path: "docs/MIGRATION_CONSOLIDATION.md"
      provides: "Production migration documentation"
      min_lines: 50
  key_links:
    - from: "backend/alembic/versions/"
      to: "001_initial_schema.py"
      via: "Only consolidated migration remains"
      pattern: "ls.*versions.*\\.py"
---

<objective>
Verify consolidated migration works correctly, remove old migrations, and document the production procedure.

Purpose: Complete the migration consolidation by validating the new migration, cleaning up old files, and documenting how to apply this change in production.

Output: Verified migration, cleaned up versions/ directory, and production migration documentation.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-migration-consolidation/07-CONTEXT.md
@.planning/phases/07-migration-consolidation/07-RESEARCH.md
@.planning/phases/07-migration-consolidation/07-01-SUMMARY.md
@.planning/phases/07-migration-consolidation/07-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create temporary database and verify migration</name>
  <files></files>
  <action>
Test the consolidated migration on a fresh temporary database:

1. Create backup of current database first (safety):
   ```bash
   make db-backup
   ```

2. Create a temporary test database:
   ```bash
   # Connect to PostgreSQL and create temp DB
   PGPASSWORD=hnf1b_pass psql -h localhost -p 5433 -U hnf1b_user -d postgres -c "CREATE DATABASE hnf1b_verify_temp;"
   ```

3. Run the consolidated migration on the temp database:
   ```bash
   cd backend
   DATABASE_URL="postgresql+asyncpg://hnf1b_user:hnf1b_pass@localhost:5433/hnf1b_verify_temp" \
     uv run alembic upgrade 001_initial_schema
   ```

4. Extract schema from temp database:
   ```bash
   pg_dump -s -O -x -U hnf1b_user -h localhost -p 5433 hnf1b_verify_temp > /tmp/migrated_schema.sql
   ```

5. Extract schema from original database:
   ```bash
   pg_dump -s -O -x -U hnf1b_user -h localhost -p 5433 hnf1b_phenopackets > /tmp/original_schema.sql
   ```

6. Compare schemas (ignore cosmetic differences):
   ```bash
   diff <(grep -v "^--" /tmp/original_schema.sql | grep -v "^$") \
        <(grep -v "^--" /tmp/migrated_schema.sql | grep -v "^$") || true
   ```

7. Check for meaningful differences:
   - Ignore: Comment differences, whitespace
   - Alert: Missing tables, indexes, functions, triggers, materialized views

8. Cleanup temp database:
   ```bash
   PGPASSWORD=hnf1b_pass psql -h localhost -p 5433 -U hnf1b_user -d postgres -c "DROP DATABASE hnf1b_verify_temp;"
   ```

If verification fails, fix issues in 001_initial_schema.sql before proceeding.
  </action>
  <verify>
```bash
# Verify consolidated migration doesn't create new differences with autogenerate
cd backend
DATABASE_URL="postgresql+asyncpg://hnf1b_user:hnf1b_pass@localhost:5433/hnf1b_phenopackets" \
  uv run alembic check 2>&1 | head -5
# Should not suggest new migrations (or only minor cosmetic ones)
```
  </verify>
  <done>Consolidated migration produces schema matching original database (verified via pg_dump comparison)</done>
</task>

<task type="auto">
  <name>Task 2: Delete old migration files</name>
  <files>backend/alembic/versions/*.py</files>
  <action>
Remove all old migration files except the new consolidated migration:

1. First, list all files that will be deleted:
   ```bash
   ls backend/alembic/versions/*.py | grep -v "001_initial_schema.py"
   ```

2. Record the commit that contains the old migrations for reference:
   ```bash
   git log --oneline -1 -- backend/alembic/versions/
   ```

3. Delete all old migration files (30 files):
   - 001_initial_phenopackets_v2_schema.py
   - 002_add_jsonb_path_indexes.py
   - 003_add_variant_search_indexes.py
   - 004_merge_heads.py
   - 0bd1567a483c_add_phenotype_metadata_to_hpo_lookup.py
   - 131bded2e26e_create_users_table.py
   - 2e28b299e3b6_remove_molecule_context_vocabulary.py
   - 30848634d515_add_deleted_at_for_soft_delete.py
   - 44ccb14dc32b_fix_mv_summary_statistics_unique_index.py
   - 48c7a668d614_fix_feature_disease_aggregation_indexes.py
   - 533c020aa76d_add_publication_index.py
   - 5f9c34e4e444_add_global_search_indexes.py
   - 62362ff6f580_add_reference_genome_tables_for_genes_.py
   - 6a1b2c3d4e5f_add_variants_to_global_search.py
   - 72e990f17d42_add_cursor_pagination_index_on_.py
   - 7b2a3c4d5e6f_add_variant_annotations_table.py
   - 88b3a0c19a89_add_phenopacket_controlled_vocabularies.py
   - 8baf0de6a441_add_fulltext_search_to_phenopackets.py
   - 8c3d4e5f6g7h_update_variant_id_constraint_for_cnvs.py
   - 8d988c04336a_add_publication_metadata_table.py
   - 93b3e6984a6c_fix_hpo_lookup_table_repopulation.py
   - 9d4e5f6g7h8i_add_5part_cnv_format.py
   - a1b2c3d4e5f6_enhance_search_vectors.py
   - add_features_count_generated_column.py
   - add_materialized_views_for_aggregations.py
   - b1e70338f190_populate_curated_hpo_terms_for_hnf1b.py
   - c22e647d6cff_add_index_for_external_references_jsonb_.py
   - db5aee5fe183_add_revision_column_for_optimistic_.py
   - f74b2759f2a9_fix_search_vector_trigger_camelcase.py
   - fff51e479b02_add_change_patch_and_summary_to_audit.py

4. Verify only the new consolidated migration remains:
   ```bash
   ls backend/alembic/versions/*.py
   # Should only show: 001_initial_schema.py
   ```

Note: Git history preserves all deleted files. They can be recovered with:
`git show HEAD~1:backend/alembic/versions/xxx.py`
  </action>
  <verify>
```bash
ls backend/alembic/versions/*.py | wc -l
# Should show: 1 (only 001_initial_schema.py)

ls backend/alembic/versions/001_initial_schema.py
# Should exist
```
  </verify>
  <done>Only 001_initial_schema.py remains in versions/ directory</done>
</task>

<task type="auto">
  <name>Task 3: Document production migration procedure</name>
  <files>docs/MIGRATION_CONSOLIDATION.md</files>
  <action>
Create documentation for the migration consolidation:

```markdown
# Migration Consolidation

**Date:** 2026-01-20
**Purpose:** Consolidate 30 Alembic migrations into a single `001_initial_schema.py`

## Background

The HNF1B Database accumulated 30 migrations over development. This consolidation:
- Simplifies the migration history
- Speeds up fresh database setup
- Reduces maintenance complexity

## What Changed

### Before
- 30 migration files in `backend/alembic/versions/`
- Sequential migration chain from initial schema through all changes

### After
- Single `001_initial_schema.py` migration
- Complete schema in `001_initial_schema.sql`
- Old migrations preserved in git history

## For Development

### Fresh Database Setup

```bash
# Start services
make hybrid-up

# Run consolidated migration
make db-upgrade

# Import data
make phenopackets-migrate
make publications-sync
make variants-sync
```

### Existing Development Database

If you have an existing development database:

1. **Option A: Full rebuild (recommended)**
   ```bash
   make db-reset        # Drop and recreate
   make phenopackets-migrate
   make publications-sync
   make variants-sync
   ```

2. **Option B: Stamp current state**
   ```bash
   cd backend
   uv run alembic stamp 001_initial_schema
   ```
   This marks the migration as applied without running it.

## For Production

Production environment uses the same Docker Compose setup and can be fully
rebuilt from Google Sheets import. The recommended approach is:

1. **Backup current database**
   ```bash
   make docker-db-backup
   ```

2. **Stop services**
   ```bash
   make docker-down
   ```

3. **Reset and reimport**
   ```bash
   make docker-clean-all  # Removes data volumes
   make docker-npm-bg     # Start fresh
   make docker-db-migrate # Run new migration
   make docker-import-full-with-sync
   ```

Alternatively, use `alembic stamp` to mark the migration as applied:
```bash
docker exec hnf1b_api alembic stamp 001_initial_schema
```

## Recovering Old Migrations

Old migrations are preserved in git history. To view them:

```bash
# List old migration files
git log --oneline --diff-filter=D -- backend/alembic/versions/

# View specific old migration
git show HEAD~1:backend/alembic/versions/88b3a0c19a89_add_phenopacket_controlled_vocabularies.py
```

## Verification

The consolidated migration was verified by:
1. Creating a fresh database with the new migration
2. Comparing schema (pg_dump) between original and migrated databases
3. Confirming `alembic check` shows no differences
4. Testing full data import cycle
```
  </action>
  <verify>
```bash
wc -l docs/MIGRATION_CONSOLIDATION.md
# Should be 80+ lines

head -5 docs/MIGRATION_CONSOLIDATION.md
# Should show title and date
```
  </verify>
  <done>Documentation file exists with 80+ lines covering dev/prod procedures</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Migration consolidation complete:
- Consolidated 30 migrations into single 001_initial_schema.py
- Verified schema matches original via pg_dump comparison
- Removed old migration files (preserved in git history)
- Created production documentation
  </what-built>
  <how-to-verify>
1. **Check migration files:**
   ```bash
   ls backend/alembic/versions/*.py
   ```
   Should show only: 001_initial_schema.py

2. **Verify migration can run on fresh database:**
   If you want to fully test, you can reset your dev database:
   ```bash
   make db-reset
   make phenopackets-migrate-test
   ```
   Then visit http://localhost:8000/docs and test the API.

3. **Check documentation:**
   Review docs/MIGRATION_CONSOLIDATION.md for accuracy.

4. **Verify git preserves history:**
   ```bash
   git status
   # Should show deleted migration files
   git log --oneline -- backend/alembic/versions/ | head -5
   # Should show history of migration changes
   ```
  </how-to-verify>
  <resume-signal>Type "approved" if migration consolidation is acceptable, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Temporary database test passes (schema comparison shows no meaningful differences)
2. Only 001_initial_schema.py and 001_initial_schema.sql remain in versions/
3. docs/MIGRATION_CONSOLIDATION.md exists with complete documentation
4. Human verification confirms migration works correctly
</verification>

<success_criteria>
- [ ] Schema comparison shows consolidated migration matches original
- [ ] Old migration files deleted (30 files removed)
- [ ] Only 001_initial_schema.py remains
- [ ] Production documentation created (80+ lines)
- [ ] Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/07-migration-consolidation/07-03-SUMMARY.md`
</output>
