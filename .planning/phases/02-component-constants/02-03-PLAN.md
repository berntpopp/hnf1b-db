---
phase: 02-component-constants
plan: 03
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - frontend/src/components/gene/ProteinStructure3D.vue
  - frontend/src/components/gene/protein-structure/StructureViewer.vue
  - frontend/src/components/gene/protein-structure/StructureControls.vue
  - frontend/src/components/gene/protein-structure/VariantPanel.vue
  - frontend/src/components/gene/protein-structure/DistanceDisplay.vue
  - frontend/src/components/gene/protein-structure/styles.css
autonomous: true

must_haves:
  truths:
    - "ProteinStructure3D.vue is under 500 lines"
    - "All sub-components exist and render correctly"
    - "3D structure visualization works unchanged"
    - "Variant selection and highlighting works"
    - "Distance calculation and display works"
  artifacts:
    - path: "frontend/src/components/gene/ProteinStructure3D.vue"
      provides: "Parent orchestrator component"
      max_lines: 400
    - path: "frontend/src/components/gene/protein-structure/StructureViewer.vue"
      provides: "NGL canvas and initialization"
      min_lines: 100
    - path: "frontend/src/components/gene/protein-structure/VariantPanel.vue"
      provides: "Variant list with filters"
      min_lines: 100
  key_links:
    - from: "frontend/src/components/gene/ProteinStructure3D.vue"
      to: "frontend/src/components/gene/protein-structure/StructureViewer.vue"
      via: "component import"
      pattern: "import StructureViewer from"
---

<objective>
Extract ProteinStructure3D.vue (1,130 lines) into manageable sub-components.

Purpose: Improve code maintainability by splitting a large monolithic component into focused, single-responsibility sub-components following Vue's "props down, events up" pattern.

Output: Parent component (~300 lines) + 4 sub-components + shared styles
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-component-constants/02-CONTEXT.md
@.planning/phases/02-component-constants/02-RESEARCH.md
@.planning/phases/02-component-constants/02-02-SUMMARY.md

# Source component to extract
@frontend/src/components/gene/ProteinStructure3D.vue

# Constants module (from Plan 02)
@frontend/src/constants/structure.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared styles and sub-component directory</name>
  <files>
frontend/src/components/gene/protein-structure/styles.css
  </files>
  <action>
Create `frontend/src/components/gene/protein-structure/` directory and shared styles.

**Create `protein-structure/styles.css`:**
Extract shared styles from ProteinStructure3D.vue that will be used by multiple sub-components:

```css
/* Shared styles for protein structure components */

.protein-3d-card {
  margin-bottom: 16px;
}

.ngl-viewport {
  width: 100%;
  height: 500px;
  border: 1px solid #e0e0e0;
  border-radius: 4px;
  background-color: white;
}

.legend-container {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 4px;
}

/* Variant panel styles */
.variant-panel {
  height: 500px;
  border: 1px solid #e0e0e0;
  border-left: none;
  border-radius: 0 4px 4px 0;
  background-color: #fafafa;
  display: flex;
  flex-direction: column;
}

.variant-panel-header {
  padding: 12px;
  background-color: #f5f5f5;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  align-items: center;
}

.variant-panel-controls {
  padding: 8px 12px;
  background-color: #f5f5f5;
  border-bottom: 1px solid #e0e0e0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.sort-select,
.filter-select {
  font-size: 12px;
}

.variant-list {
  flex: 1;
  overflow-y: auto;
  background-color: transparent;
}

.variant-item-active {
  background-color: #e3f2fd !important;
  border-left: 3px solid #1976d2;
}

.variant-item-hover {
  background-color: #f5f5f5;
}
```
  </action>
  <verify>
Run: `ls -la /home/bernt-popp/development/hnf1b-db/frontend/src/components/gene/protein-structure/` - directory and styles.css exist
  </verify>
  <done>
Directory created, shared styles file exists
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StructureViewer sub-component</name>
  <files>frontend/src/components/gene/protein-structure/StructureViewer.vue</files>
  <action>
Create `StructureViewer.vue` - the NGL.js 3D viewer component.

**CRITICAL:** NGL objects MUST remain at module scope (outside Vue reactivity) to avoid Three.js proxy conflicts. This is already done in the source file and MUST be preserved.

This component handles:
- NGL Stage initialization
- Structure loading (PDB 2H8R)
- Representation updates (cartoon, surface, ball+stick)
- DNA visibility toggle
- Domain coloring
- Variant highlighting (spacefill + ball+stick + label)
- Distance line rendering
- Window resize handling

**Props (receive from parent):**
- `representation: String` - 'cartoon', 'surface', 'ball+stick'
- `showDna: Boolean` - toggle DNA visibility
- `colorByDomain: Boolean` - toggle domain coloring
- `activeVariant: Object | null` - current variant to highlight
- `activeVariantPosition: Number | null` - AA position of active variant
- `distanceInfo: Object | null` - distance calculation result
- `showDistanceLine: Boolean` - toggle distance line

**Events (emit to parent):**
- `structure-ready` - when structure is loaded and calculator initialized
- `calculator-created: calculator` - passes DNADistanceCalculator instance to parent

**Expose via ref:**
- `resetView()` method
- `nglStage` for direct access if needed

Extract the following from ProteinStructure3D.vue:
- Module-scope NGL variables (nglStage, nglStructureComponent, etc.)
- `initializeNGL()` method
- `updateRepresentation()` method
- `addDomainColoredRepresentations()` method
- `highlightActiveVariant()` method
- `addDistanceLine()`, `removeDistanceLine()` methods
- `handleResize()` method
- Import constants from `@/constants/structure`
- Import colors from `@/utils/colors`
- Import DNADistanceCalculator from `@/utils/dnaDistanceCalculator`

Template: Just the NGL viewport div with ref="nglContainer"

**Options API** - match existing codebase style (not Composition API).
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint -- --fix src/components/gene/protein-structure/StructureViewer.vue` - no errors
  </verify>
  <done>
StructureViewer.vue exists with NGL initialization and rendering logic
  </done>
</task>

<task type="auto">
  <name>Task 3: Create StructureControls, VariantPanel, and DistanceDisplay sub-components</name>
  <files>
frontend/src/components/gene/protein-structure/StructureControls.vue
frontend/src/components/gene/protein-structure/VariantPanel.vue
frontend/src/components/gene/protein-structure/DistanceDisplay.vue
  </files>
  <action>
Create the remaining three sub-components.

**StructureControls.vue** - Representation and toggle controls:

Props:
- `representation: String` (v-model compatible)
- `showDna: Boolean` (v-model compatible)
- `colorByDomain: Boolean` (v-model compatible)
- `showDistanceButton: Boolean` - whether to show distance button
- `distanceFormatted: String` - formatted distance value
- `showDistanceLine: Boolean` - current state of distance line

Events:
- `update:representation`
- `update:showDna`
- `update:colorByDomain`
- `reset-view`
- `toggle-distance`

Template: The v-row with v-btn-toggle, v-switches, and action buttons.

---

**VariantPanel.vue** - Variant list with filtering/sorting:

Props:
- `variants: Array` - all variants in structure range
- `selectedId: String | null` - currently selected variant ID
- `hoveredId: String | null` - currently hovered variant ID
- `distanceCache: Object` - cached distance info per variant

Events:
- `select: variant` - variant selected
- `hover: variant` - variant hovered
- `unhover` - mouse left variant
- `view-details: variant` - "View Details" clicked

Data:
- `sortBy`, `filterPathogenicity`, `filterDistance`
- `sortOptions`, `pathogenicityOptions`, `distanceOptions`

Computed:
- `filteredAndSortedVariants`

Methods:
- `clearFilters()`
- Helper methods for getting variant info (chip colors, labels, etc.)

Template: The variant-panel div with header, controls, and v-list.

---

**DistanceDisplay.vue** - Distance alert and legends:

Props:
- `distanceInfo: Object | null` - current distance calculation result
- `showDistanceLine: Boolean`
- `colorByDomain: Boolean`
- `variant: Object | null` - current variant (for "not in structure" warning)
- `variantInStructure: Boolean`
- `showAllVariants: Boolean` - mode flag

Template:
- Distance alert (v-alert with distance info)
- Legend row (pathogenicity chips, domain chips when colorByDomain)
- Warning alerts for variants not in structure

Import `getDistanceAlertType()` and related helpers, or define locally.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint -- --fix src/components/gene/protein-structure/` - no errors in any sub-component
  </verify>
  <done>
All three sub-components exist with correct props/events
  </done>
</task>

<task type="auto">
  <name>Task 4: Refactor ProteinStructure3D.vue to orchestrator</name>
  <files>frontend/src/components/gene/ProteinStructure3D.vue</files>
  <action>
Refactor the parent component to be an orchestrator that delegates to sub-components.

**Keep in parent:**
- Props (`variants`, `currentVariantId`, `showAllVariants`)
- Emit (`variant-clicked`)
- State management (loading, error, selectedVariantId, hoveredVariantId, etc.)
- Computed properties for active variant
- Distance calculator reference and distance cache
- Coordination between sub-components

**Replace inline code with component usage:**

```vue
<template>
  <v-card class="protein-3d-card">
    <v-card-title>...</v-card-title>

    <v-card-text>
      <!-- Info alert, loading, error states stay here -->

      <v-row v-show="!loading && !error" no-gutters>
        <v-col :cols="showAllVariants ? 8 : 12">
          <StructureViewer
            ref="viewer"
            :representation="representation"
            :show-dna="showDNA"
            :color-by-domain="colorByDomain"
            :active-variant="activeVariant"
            :active-variant-position="activeVariantAAPosition"
            :distance-info="currentVariantDistanceInfo"
            :show-distance-line="showDistanceLine"
            @structure-ready="onStructureReady"
            @calculator-created="onCalculatorCreated"
          />
        </v-col>

        <v-col v-if="showAllVariants" cols="4">
          <VariantPanel
            :variants="variantsInStructure"
            :selected-id="selectedVariantId"
            :hovered-id="hoveredVariantId"
            :distance-cache="variantDistanceCache"
            @select="selectVariant"
            @hover="hoverVariant"
            @unhover="unhoverVariant"
            @view-details="emitVariantClicked"
          />
        </v-col>
      </v-row>

      <StructureControls
        v-if="!loading && !error"
        v-model:representation="representation"
        v-model:show-dna="showDNA"
        v-model:color-by-domain="colorByDomain"
        :show-distance-button="activeVariantInStructure && !!activeVariantDistanceInfo"
        :distance-formatted="activeVariantDistanceInfo?.distanceFormatted"
        :show-distance-line="showDistanceLine"
        @reset-view="resetView"
        @toggle-distance="toggleDistanceLine"
      />

      <DistanceDisplay
        v-if="!loading && !error"
        :distance-info="activeVariantDistanceInfo"
        :show-distance-line="showDistanceLine"
        :color-by-domain="colorByDomain"
        :variant="activeVariant"
        :variant-in-structure="activeVariantInStructure"
        :show-all-variants="showAllVariants"
        :selected-variant="selectedVariant"
        :selected-variant-in-structure="selectedVariantInStructure"
        @view-details="emitVariantClicked"
      />
    </v-card-text>
  </v-card>
</template>

<script>
import StructureViewer from './protein-structure/StructureViewer.vue';
import StructureControls from './protein-structure/StructureControls.vue';
import VariantPanel from './protein-structure/VariantPanel.vue';
import DistanceDisplay from './protein-structure/DistanceDisplay.vue';

export default {
  name: 'ProteinStructure3D',
  components: {
    StructureViewer,
    StructureControls,
    VariantPanel,
    DistanceDisplay,
  },
  // ... rest of component
};
</script>
```

**Event handlers:**
- `onStructureReady()`: Set structureLoaded = true, calculate distances
- `onCalculatorCreated(calculator)`: Store reference for distance calculations
- `resetView()`: Call `this.$refs.viewer.resetView()`
- `toggleDistanceLine()`: Toggle showDistanceLine state

Remove all NGL-related code that moved to StructureViewer.
Remove template code that moved to sub-components.

Target: < 400 lines total.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint && npm test` - passes
Run: `wc -l frontend/src/components/gene/ProteinStructure3D.vue` - under 400 lines
  </verify>
  <done>
Parent component is under 400 lines, delegates to sub-components
  </done>
</task>

</tasks>

<verification>
1. ProteinStructure3D.vue is under 500 lines (target: ~300-400)
2. All 4 sub-components exist in protein-structure/ directory
3. `npm run lint` passes for all new files
4. `npm test` passes
5. Manual verification: 3D viewer loads and functions correctly
   - Structure renders
   - Representation toggles work
   - Variant highlighting works
   - Distance line toggles work
   - Variant panel filters/sorts work (in showAllVariants mode)
</verification>

<success_criteria>
- [x] ProteinStructure3D.vue under 500 lines
- [x] StructureViewer.vue handles all NGL logic
- [x] StructureControls.vue handles toggles and buttons
- [x] VariantPanel.vue handles variant list and filtering
- [x] DistanceDisplay.vue handles alerts and legends
- [x] All tests pass
- [x] No lint errors
- [x] 3D visualization works correctly (manual verification)
</success_criteria>

<output>
After completion, create `.planning/phases/02-component-constants/02-03-SUMMARY.md`
</output>
