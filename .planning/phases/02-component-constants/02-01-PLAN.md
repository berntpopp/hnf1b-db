---
phase: 02-component-constants
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/constants.py
autonomous: true

must_haves:
  truths:
    - "Backend has centralized constants file"
    - "Magic numbers extracted from service files"
    - "All constants have JSDoc/docstring documentation"
    - "Existing functionality unchanged"
  artifacts:
    - path: "backend/app/constants.py"
      provides: "Centralized domain constants"
      min_lines: 50
      contains: "STRUCTURE_START"
  key_links:
    - from: "backend/app/reference/service.py"
      to: "backend/app/constants.py"
      via: "import statement"
      pattern: "from app\\.constants import"
---

<objective>
Create centralized backend constants module for HNF1B domain values.

Purpose: Extract hardcoded magic numbers from backend code into documented constants for maintainability and consistency across the codebase.

Output: `backend/app/constants.py` with domain-specific constants
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-component-constants/02-CONTEXT.md
@.planning/phases/02-component-constants/02-RESEARCH.md

# Existing config to understand separation of concerns
@backend/app/core/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create backend constants module</name>
  <files>backend/app/constants.py</files>
  <action>
Create `backend/app/constants.py` with documented domain constants.

Follow the structure from RESEARCH.md:
- Module docstring explaining purpose and usage
- Section headers for organization
- Each constant has a docstring/comment explaining its purpose

Include these constants (from RESEARCH.md appendix):

**PDB 2H8R Structure Boundaries:**
- STRUCTURE_START = 90 (first residue visible)
- STRUCTURE_END = 308 (last residue visible)
- STRUCTURE_GAP_START = 187 (gap start - linker not resolved)
- STRUCTURE_GAP_END = 230 (gap end)

**HNF1B Gene Boundaries (GRCh38):**
- HNF1B_GENE_START = 37686430
- HNF1B_GENE_END = 37745059
- HNF1B_CHROMOSOME = "17"

**17q12 Region (for reference service):**
- CHR17Q12_REGION_START = 36000000
- CHR17Q12_REGION_END = 39900000

**Variant Classification:**
- CNV_SIZE_THRESHOLD = 50 (bp threshold for CNV vs indel)
- VARIANT_RECODER_BATCH_SIZE = 200

**Domain Boundaries (UniProt P35680):**
- DOMAIN_BOUNDARIES dict with dimerization, pou_specific, pou_homeodomain, transactivation

**Caching:**
- CACHE_MAX_AGE_SECONDS = 86400

Use SCREAMING_SNAKE_CASE for all constants (PEP 8 convention).
Do NOT include env-based config (that stays in config.py/config.yaml).
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/hnf1b-db/backend && uv run python -c "from app.constants import STRUCTURE_START, DOMAIN_BOUNDARIES; print(f'STRUCTURE_START={STRUCTURE_START}'); print(f'Domains: {list(DOMAIN_BOUNDARIES.keys())}')"` - should print values without error
  </verify>
  <done>
Constants file exists with all documented domain values, imports successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Update backend files to use constants</name>
  <files>
backend/app/reference/service.py
backend/app/reference/router.py
backend/app/phenopackets/routers/aggregations/all_variants.py
backend/app/phenopackets/variant_search_validation.py
  </files>
  <action>
Update backend files to import and use constants from the new module.

For each file, replace hardcoded values with constant imports:

1. `reference/service.py`:
   - Replace 36000000-39900000 region with CHR17Q12_REGION_START/END
   - Keep rate limit delay in config.yaml (behavior, not constant)

2. `reference/router.py`:
   - Replace 86400 cache max age with CACHE_MAX_AGE_SECONDS

3. `aggregations/all_variants.py`:
   - Replace inline domain boundaries dict with DOMAIN_BOUNDARIES import

4. `variant_search_validation.py`:
   - Replace 200 batch size with VARIANT_RECODER_BATCH_SIZE

Add import statement at top of each file:
```python
from app.constants import CONSTANT_NAME
```

Ensure no functionality changes - only source of values changes.
  </action>
  <verify>
Run: `cd /home/bernt-popp/development/hnf1b-db/backend && make check` - all tests pass, no lint/type errors
  </verify>
  <done>
All backend files use constants from centralized module, tests pass
  </done>
</task>

</tasks>

<verification>
1. Constants module exists and is importable
2. `make check` passes in backend directory
3. No hardcoded magic numbers remain in modified files
4. API behavior unchanged (same values, different source)
</verification>

<success_criteria>
- [x] `backend/app/constants.py` exists with documented constants
- [x] Backend files import from constants module
- [x] All backend tests pass
- [x] No lint or type errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-component-constants/02-01-SUMMARY.md`
</output>
