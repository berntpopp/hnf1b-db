---
phase: 05-chart-polish
plan: 05
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/components/analyses/VariantComparisonChart.vue
  - frontend/src/components/analyses/BoxPlotChart.vue
  - frontend/tests/components/analyses/VariantComparisonChart.test.js
  - frontend/tests/components/analyses/BoxPlotChart.test.js
autonomous: true

must_haves:
  truths:
    - "VariantComparisonChart has accessibility attributes"
    - "VariantComparisonChart has PNG and CSV export options"
    - "BoxPlotChart has accessibility attributes"
    - "BoxPlotChart has PNG and CSV export options"
    - "Both charts have entry animations with reduced-motion support"
  artifacts:
    - path: "frontend/src/components/analyses/VariantComparisonChart.vue"
      provides: "Accessible comparison chart with export"
      contains: "aria-labelledby"
    - path: "frontend/src/components/analyses/BoxPlotChart.vue"
      provides: "Accessible violin/box plot with export"
      contains: "aria-labelledby"
  key_links:
    - from: "frontend/src/components/analyses/VariantComparisonChart.vue"
      to: "frontend/src/utils/chartAnimation.js"
      via: "import animation utilities"
      pattern: "import.*getAnimationDuration.*chartAnimation"
    - from: "frontend/src/components/analyses/BoxPlotChart.vue"
      to: "frontend/src/utils/export.js"
      via: "import export utilities"
      pattern: "import.*exportToPNG.*export"
---

<objective>
Add accessibility, animations, and upgrade export functionality for VariantComparisonChart and BoxPlotChart components.

Purpose: Complete Phase 5 requirements for the remaining two chart types. Both already have SVG export, need PNG/CSV and accessibility.
Output: Both charts with ARIA attributes, animations, and full export menu.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-chart-polish/05-CONTEXT.md
@.planning/phases/05-chart-polish/05-RESEARCH.md
@.planning/phases/05-chart-polish/05-01-SUMMARY.md
@frontend/src/components/analyses/VariantComparisonChart.vue
@frontend/src/components/analyses/BoxPlotChart.vue
@frontend/src/utils/chartAnimation.js
@frontend/src/utils/chartAccessibility.js
@frontend/src/utils/export.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Polish VariantComparisonChart</name>
  <files>
    frontend/src/components/analyses/VariantComparisonChart.vue
    frontend/tests/components/analyses/VariantComparisonChart.test.js
  </files>
  <action>
Modify VariantComparisonChart.vue:

1. Import utilities:
```javascript
import { addChartAccessibility } from '@/utils/chartAccessibility';
import { getAnimationDuration, getStaggerDelay, prefersReducedMotion } from '@/utils/chartAnimation';
import { exportToPNG, exportToCSV, getTimestamp } from '@/utils/export';
import ChartExportMenu from '@/components/common/ChartExportMenu.vue';
```

2. Add accessibility after creating SVG in renderChart():
```javascript
const group1Name = this.comparisonData.group1_name;
const group2Name = this.comparisonData.group2_name;
const description = `Phenotype comparison chart. ${group1Name} (n=${this.comparisonData.group1_count}) vs ${group2Name} (n=${this.comparisonData.group2_count}). Showing prevalence of ${data.length} phenotypes.`;

const rootSvg = d3.select(this.$refs.chart).select('svg');
addChartAccessibility(rootSvg, 'variant-comp-title-' + this._uid, 'variant-comp-desc-' + this._uid, 'Variant Type Phenotype Comparison', description);
```

3. Add bar animation (height from 0):
```javascript
const duration = getAnimationDuration(400);
const staggerDelay = 20;

// For each bar rect, start with height=0 and y at baseline
// Animate to final height and y position
.attr('y', svgHeight)  // Start at baseline
.attr('height', 0)     // Start with 0 height
.transition()
.duration(duration)
.delay((d, i) => getStaggerDelay(i, staggerDelay))
.attr('y', (d) => y(d.group1_percentage))  // Final y
.attr('height', svgHeight - y(d.group1_percentage));  // Final height
```

4. Add aria-hidden="true" to bar rects

5. Update template to use ChartExportMenu:
```html
<div class="export-controls">
  <ChartExportMenu
    @export-png="handleExportPNG"
    @export-csv="handleExportCSV"
  />
  <button class="export-btn" title="Download as SVG" @click="exportSVG">
    <span class="export-icon">mdi-file-image</span> SVG
  </button>
</div>
```

6. Add export methods:
```javascript
handleExportPNG() {
  const svg = this.$refs.chart.querySelector('svg');
  if (!svg) return;
  const filename = `variant-comparison-${this.comparisonType}-${this.organSystemFilter}-${getTimestamp()}`;
  exportToPNG(svg, filename, 2);
},

handleExportCSV() {
  const allPhenotypes = this.comparisonData.phenotypes;
  const informativePhenotypes = this.filterUninformativePhenotypes(allPhenotypes);
  const data = this.filterPhenotypesByOrganSystem(informativePhenotypes, this.organSystemFilter);

  const csvData = data.map(d => ({
    phenotype: d.hpo_label,
    hpo_id: d.hpo_id || '',
    group1_present: d.group1_present,
    group1_total: d.group1_total,
    group1_percentage: d.group1_percentage.toFixed(1),
    group2_present: d.group2_present,
    group2_total: d.group2_total,
    group2_percentage: d.group2_percentage.toFixed(1),
    p_value_fisher: d.p_value?.toFixed(4) ?? '',
    p_value_fdr: d.p_value_fdr?.toFixed(4) ?? '',
    effect_size_cohens_h: d.effect_size?.toFixed(3) ?? '',
    significant: d.significant ? 'yes' : 'no'
  }));

  const filename = `variant-comparison-${this.comparisonType}-${this.organSystemFilter}-${getTimestamp()}`;
  exportToCSV(csvData, [
    'phenotype', 'hpo_id', 'group1_present', 'group1_total', 'group1_percentage',
    'group2_present', 'group2_total', 'group2_percentage',
    'p_value_fisher', 'p_value_fdr', 'effect_size_cohens_h', 'significant'
  ], filename);
},
```

7. Register ChartExportMenu component

8. Create/update test file with accessibility and export tests
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/VariantComparisonChart.test.js --run
  </verify>
  <done>
VariantComparisonChart has accessibility, animation, and PNG/CSV export. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Polish BoxPlotChart</name>
  <files>
    frontend/src/components/analyses/BoxPlotChart.vue
    frontend/tests/components/analyses/BoxPlotChart.test.js
  </files>
  <action>
Modify BoxPlotChart.vue:

1. Import utilities:
```javascript
import { addChartAccessibility } from '@/utils/chartAccessibility';
import { getAnimationDuration, prefersReducedMotion } from '@/utils/chartAnimation';
import { exportToPNG, exportToCSV, getTimestamp } from '@/utils/export';
import ChartExportMenu from '@/components/common/ChartExportMenu.vue';
```

2. Add accessibility after creating SVG in renderChart():
```javascript
const pathogenicN = this.pathogenicDistances.length;
const vusN = this.vusDistances.length;
const description = `DNA distance violin plot. Pathogenic/Likely Pathogenic: ${pathogenicN} variants. VUS: ${vusN} variants. ${this.pValueSignificant ? 'Difference is statistically significant.' : ''}`;

const rootSvg = d3.select(this.$refs.chartContainer).select('svg');
addChartAccessibility(rootSvg, 'boxplot-title-' + this._uid, 'boxplot-desc-' + this._uid, 'DNA Distance by Pathogenicity', description);
```

3. Add violin/box animation:
- Violin shape: start with 0 width, expand
- Box: fade in
- Points: fade in with stagger

```javascript
const duration = getAnimationDuration(600);

// Violin path animation
if (!prefersReducedMotion()) {
  violinPath
    .attr('transform', `translate(${centerX}, 0) scale(0, 1)`)
    .transition()
    .duration(duration)
    .attr('transform', `translate(0, 0) scale(1, 1)`);
}

// Points fade in
.attr('fill-opacity', 0)
.transition()
.delay((d, i) => getStaggerDelay(i, 10))
.duration(duration / 2)
.attr('fill-opacity', 0.7);
```

4. Update template to use ChartExportMenu:
```html
<div class="export-controls">
  <ChartExportMenu
    @export-png="handleExportPNG"
    @export-csv="handleExportCSV"
  />
  <button class="export-btn" title="Download as SVG" @click="exportSVG">
    <span class="export-icon">mdi-file-image</span> SVG
  </button>
</div>
```

5. Add export methods:
```javascript
handleExportPNG() {
  const svg = this.$refs.chartContainer?.querySelector('svg');
  if (!svg) return;
  const filename = `dna-distance-violin-plot-${getTimestamp()}`;
  exportToPNG(svg, filename, 2);
},

handleExportCSV() {
  const data = [
    ...this.pathogenicDistances.map(v => ({
      classification: 'P/LP',
      protein_change: v.protein || v.label || '',
      aa_position: v.aaPosition,
      distance_angstroms: v.distance.toFixed(2),
      category: v.category,
      verdict: v.classificationVerdict || ''
    })),
    ...this.vusDistances.map(v => ({
      classification: 'VUS',
      protein_change: v.protein || v.label || '',
      aa_position: v.aaPosition,
      distance_angstroms: v.distance.toFixed(2),
      category: v.category,
      verdict: v.classificationVerdict || ''
    }))
  ];

  const filename = `dna-distance-data-${getTimestamp()}`;
  exportToCSV(data, [
    'classification', 'protein_change', 'aa_position',
    'distance_angstroms', 'category', 'verdict'
  ], filename);
},
```

6. Register ChartExportMenu component

7. Create/update test file with accessibility and export tests
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/BoxPlotChart.test.js --run
  </verify>
  <done>
BoxPlotChart has accessibility, animation, and PNG/CSV export. Tests pass.
  </done>
</task>

</tasks>

<verification>
Run tests for both components:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/VariantComparisonChart.test.js tests/components/analyses/BoxPlotChart.test.js --run
```

Verify lint:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint
```

Manual verification (dev server):
1. Navigate to Variant Comparison page, verify bars animate and export works
2. Navigate to DNA Distance Analysis, verify violin/points animate and export works
3. Enable reduced motion, refresh both pages, verify no animation
</verification>

<success_criteria>
- [ ] VariantComparisonChart has role="img" and aria-labelledby
- [ ] VariantComparisonChart bars animate with stagger
- [ ] VariantComparisonChart has PNG, CSV, SVG export options
- [ ] BoxPlotChart has role="img" and aria-labelledby
- [ ] BoxPlotChart violin/points animate
- [ ] BoxPlotChart has PNG, CSV, SVG export options
- [ ] Both respect prefers-reduced-motion
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-chart-polish/05-05-SUMMARY.md`
</output>
