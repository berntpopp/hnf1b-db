---
phase: 05-chart-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/components/analyses/DonutChart.vue
  - frontend/tests/components/analyses/DonutChart.test.js
autonomous: true

must_haves:
  truths:
    - "DonutChart has arc tween animation on initial load"
    - "DonutChart animation is disabled when prefers-reduced-motion"
    - "DonutChart has screen reader description with all categories"
    - "DonutChart has export menu with PNG and CSV options"
    - "DonutChart data updates use smooth transitions without full animation replay"
  artifacts:
    - path: "frontend/src/components/analyses/DonutChart.vue"
      provides: "Accessible, animated donut chart with export"
      contains: "aria-labelledby"
    - path: "frontend/tests/components/analyses/DonutChart.test.js"
      provides: "Tests for accessibility and export"
      min_lines: 50
  key_links:
    - from: "frontend/src/components/analyses/DonutChart.vue"
      to: "frontend/src/utils/chartAnimation.js"
      via: "import animation utilities"
      pattern: "import.*getAnimationDuration.*chartAnimation"
    - from: "frontend/src/components/analyses/DonutChart.vue"
      to: "frontend/src/utils/chartAccessibility.js"
      via: "import accessibility utilities"
      pattern: "import.*addChartAccessibility.*chartAccessibility"
    - from: "frontend/src/components/analyses/DonutChart.vue"
      to: "frontend/src/components/common/ChartExportMenu.vue"
      via: "component registration"
      pattern: "ChartExportMenu"
---

<objective>
Add accessibility, entry animations, and export functionality to DonutChart component.

Purpose: Fulfill A11Y-01, A11Y-02, A11Y-05, CHART-01, CHART-04, CHART-05, CHART-06, CHART-07, CHART-08, CHART-09 requirements for donut charts.
Output: DonutChart.vue with ARIA attributes, staggered arc animation, and export menu.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-chart-polish/05-CONTEXT.md
@.planning/phases/05-chart-polish/05-RESEARCH.md
@.planning/phases/05-chart-polish/05-01-SUMMARY.md
@frontend/src/components/analyses/DonutChart.vue
@frontend/src/utils/chartAnimation.js
@frontend/src/utils/chartAccessibility.js
@frontend/src/utils/export.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accessibility to DonutChart</name>
  <files>frontend/src/components/analyses/DonutChart.vue</files>
  <action>
Modify DonutChart.vue to add accessibility:

1. Import utilities at top of script:
```javascript
import { addChartAccessibility, generateDonutDescription } from '@/utils/chartAccessibility';
```

2. In renderChart() after creating SVG:
- Generate unique IDs: `const titleId = 'donut-title-' + this._uid;`
- Generate unique IDs: `const descId = 'donut-desc-' + this._uid;`
- Call d3.select(svg.node().parentNode) to get the root SVG element
- Generate description: `const description = generateDonutDescription(dataEntries.map(([label, count]) => ({label, count})), totalValue);`
- Call addChartAccessibility(rootSvg, titleId, descId, 'Distribution Chart', description)

3. Add aria-hidden="true" to the decorative slice paths in the selectAll('path.slice') chain

4. Ensure the legend does NOT have aria-hidden (it provides meaningful text)
  </action>
  <verify>
Manually inspect DonutChart.vue for:
- role="img" on SVG
- aria-labelledby attribute
- title and desc elements
- aria-hidden on decorative paths
  </verify>
  <done>
DonutChart has ARIA attributes. Screen readers can access chart description with all categories and percentages.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add entry animation to DonutChart</name>
  <files>frontend/src/components/analyses/DonutChart.vue</files>
  <action>
Modify DonutChart.vue to add arc tween animation:

1. Import animation utilities:
```javascript
import { getAnimationDuration, getStaggerDelay, prefersReducedMotion } from '@/utils/chartAnimation';
```

2. Add data property to track if this is initial render vs data update:
```javascript
data() {
  return {
    isInitialRender: true,
  };
},
```

3. Create arcTween method:
```javascript
arcTween(arc) {
  return function(d) {
    const interpolate = d3.interpolate(
      this._current || { startAngle: 0, endAngle: 0 },
      d
    );
    this._current = interpolate(1);
    return function(t) {
      return arc(interpolate(t));
    };
  };
},
```

4. Modify the path creation in renderChart():
```javascript
const duration = this.isInitialRender ? getAnimationDuration(400) : getAnimationDuration(200);
const staggerDelay = 50;

svg
  .selectAll('path.slice')
  .data(dataReady)
  .enter()
  .append('path')
  .attr('class', 'slice')
  .attr('fill', (d) => color(d.data[0]))
  .attr('stroke', 'white')
  .style('stroke-width', '2px')
  .style('opacity', 0.7)
  .attr('aria-hidden', 'true')
  .each(function(d) { this._current = { startAngle: 0, endAngle: 0 }; })
  .transition()
  .duration(duration)
  .delay((d, i) => getStaggerDelay(i, staggerDelay))
  .attrTween('d', this.arcTween(arc))
  // Add mouse events AFTER transition completes
  .on('end', function() {
    d3.select(this)
      .on('mouseover', ...)  // existing handlers
      .on('mousemove', ...)
      .on('mouseout', ...);
  });
```

5. Set isInitialRender = false after first render completes

6. For data updates (in watcher), use shorter duration and don't replay full animation:
- Use D3's selection.merge() pattern for update vs enter
- Transitions should morph between states smoothly
  </action>
  <verify>
Start frontend dev server, navigate to Aggregations page, observe:
1. Donut chart arcs animate in one by one
2. Refresh page with prefers-reduced-motion enabled - no animation
  </verify>
  <done>
DonutChart has staggered arc animation on load. Animation disabled when reduced motion preferred.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add export functionality and tests</name>
  <files>
    frontend/src/components/analyses/DonutChart.vue
    frontend/tests/components/analyses/DonutChart.test.js
  </files>
  <action>
1. Add export to DonutChart.vue:

Import:
```javascript
import { exportToPNG, exportToCSV, getTimestamp } from '@/utils/export';
import ChartExportMenu from '@/components/common/ChartExportMenu.vue';
```

Register component:
```javascript
components: {
  ChartExportMenu,
},
```

Update template to include export menu:
```html
<template>
  <div class="donut-chart-container">
    <div class="chart-header">
      <ChartExportMenu
        @export-png="handleExportPNG"
        @export-csv="handleExportCSV"
      />
    </div>
    <div class="chart-wrapper">
      <div ref="chart" class="chart" />
      <div ref="legend" class="legend" />
    </div>
  </div>
</template>
```

Add methods:
```javascript
handleExportPNG() {
  const svg = this.$refs.chart.querySelector('svg');
  if (!svg) return;
  const filename = `donut-chart-${getTimestamp()}`;
  exportToPNG(svg, filename, 2);
},
handleExportCSV() {
  const data = this.chartData.grouped_counts.map(item => ({
    category: item._id,
    count: item.count,
    percentage: ((item.count / this.chartData.total_count) * 100).toFixed(1)
  }));
  const filename = `donut-chart-${getTimestamp()}`;
  exportToCSV(data, ['category', 'count', 'percentage'], filename);
},
```

Add CSS for chart-header:
```css
.chart-header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
}
```

2. Create/update test file:
- Test that ChartExportMenu is rendered
- Test handleExportPNG is called when export-png event fires
- Test handleExportCSV is called when export-csv event fires
- Test accessibility attributes are present on SVG
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/DonutChart.test.js --run
  </verify>
  <done>
DonutChart has export menu. PNG exports at 2x resolution. CSV exports with category, count, percentage headers. Tests pass.
  </done>
</task>

</tasks>

<verification>
Run DonutChart tests:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/DonutChart.test.js --run
```

Verify lint:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint
```

Manual verification (dev server):
1. Navigate to Aggregations page
2. Verify donut chart animates on load
3. Click Export menu, verify PNG and CSV options work
4. Enable reduced motion in system settings, refresh, verify no animation
</verification>

<success_criteria>
- [ ] DonutChart has role="img" and aria-labelledby on SVG
- [ ] DonutChart has title and desc elements with generated description
- [ ] DonutChart arcs animate with staggered timing on load
- [ ] Animation respects prefers-reduced-motion
- [ ] Export menu renders with PNG and CSV options
- [ ] PNG export downloads at 2x resolution with white background
- [ ] CSV export downloads with snake_case headers
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-chart-polish/05-02-SUMMARY.md`
</output>
