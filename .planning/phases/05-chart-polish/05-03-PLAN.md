---
phase: 05-chart-polish
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/components/analyses/StackedBarChart.vue
  - frontend/tests/components/analyses/StackedBarChart.test.js
autonomous: true

must_haves:
  truths:
    - "StackedBarChart has height tween animation on initial load"
    - "StackedBarChart animation is disabled when prefers-reduced-motion"
    - "StackedBarChart has screen reader description with top features"
    - "StackedBarChart has export menu with PNG and CSV options"
    - "Bars grow from baseline with staggered timing"
  artifacts:
    - path: "frontend/src/components/analyses/StackedBarChart.vue"
      provides: "Accessible, animated bar chart with export"
      contains: "aria-labelledby"
    - path: "frontend/tests/components/analyses/StackedBarChart.test.js"
      provides: "Tests for accessibility and export"
      min_lines: 40
  key_links:
    - from: "frontend/src/components/analyses/StackedBarChart.vue"
      to: "frontend/src/utils/chartAnimation.js"
      via: "import animation utilities"
      pattern: "import.*getAnimationDuration.*chartAnimation"
    - from: "frontend/src/components/analyses/StackedBarChart.vue"
      to: "frontend/src/components/common/ChartExportMenu.vue"
      via: "component registration"
      pattern: "ChartExportMenu"
---

<objective>
Add accessibility, entry animations, and export functionality to StackedBarChart component.

Purpose: Fulfill A11Y-01, A11Y-02, A11Y-05, CHART-02, CHART-04, CHART-05, CHART-06, CHART-07, CHART-08, CHART-09 requirements for bar charts.
Output: StackedBarChart.vue with ARIA attributes, staggered bar animation, and export menu.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-chart-polish/05-CONTEXT.md
@.planning/phases/05-chart-polish/05-RESEARCH.md
@.planning/phases/05-chart-polish/05-01-SUMMARY.md
@frontend/src/components/analyses/StackedBarChart.vue
@frontend/src/utils/chartAnimation.js
@frontend/src/utils/chartAccessibility.js
@frontend/src/utils/export.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accessibility to StackedBarChart</name>
  <files>frontend/src/components/analyses/StackedBarChart.vue</files>
  <action>
Modify StackedBarChart.vue to add accessibility:

1. Import utilities at top of script:
```javascript
import { addChartAccessibility, generateBarChartDescription } from '@/utils/chartAccessibility';
```

2. In renderChart() after creating SVG and before drawing bars:
- Generate unique IDs using component uid or a counter
- Prepare data for description generator:
```javascript
const descriptionData = data.map(d => ({
  label: d.group,
  present: d.present,
  absent: d.absent
}));
const description = generateBarChartDescription(descriptionData);
```
- Get root SVG element: `const rootSvg = d3.select(this.$refs.chart).select('svg');`
- Call `addChartAccessibility(rootSvg, titleId, descId, 'Phenotype Prevalence Chart', description);`

3. Add aria-hidden="true" to the bar rects since they are decorative (screen reader description provides the data)

4. Keep axis labels accessible (don't hide them)
  </action>
  <verify>
Manually inspect StackedBarChart.vue for:
- role="img" on SVG
- aria-labelledby attribute
- title and desc elements
- aria-hidden on bar rects
  </verify>
  <done>
StackedBarChart has ARIA attributes. Screen readers can access chart description with top features and penetrance.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add entry animation to StackedBarChart</name>
  <files>frontend/src/components/analyses/StackedBarChart.vue</files>
  <action>
Modify StackedBarChart.vue to add bar height animation:

1. Import animation utilities:
```javascript
import { getAnimationDuration, getStaggerDelay, prefersReducedMotion } from '@/utils/chartAnimation';
```

2. Modify the bar creation in renderChart() to animate from baseline:

For horizontal stacked bars (current implementation uses horizontal bars):
- Bars should start with width: 0 and animate to final width
- Use staggered delay based on row index

```javascript
const duration = getAnimationDuration(400);
const staggerDelay = 30;

// Initial state: width 0, positioned at x=0
svg
  .append('g')
  .selectAll('g')
  .data(stackedData)
  .join('g')
  .attr('fill', (d) => color(d.key))
  .selectAll('rect')
  .data((d) => d)
  .join('rect')
  .attr('y', (d) => y(d.data.group))
  .attr('x', 0)  // Start at 0
  .attr('width', 0)  // Start with 0 width
  .attr('height', y.bandwidth())
  .attr('stroke', 'white')
  .attr('stroke-width', 1)
  .attr('aria-hidden', 'true')
  .transition()
  .duration(duration)
  .delay((d, i) => getStaggerDelay(i, staggerDelay))
  .attr('x', (d) => x(d[0]))
  .attr('width', (d) => x(d[1]) - x(d[0]));
```

3. Re-attach mouse event handlers after transition completes using .on('end', ...)

4. For data updates (filter change, display limit change):
- Use shorter duration
- Don't replay full animation, just smooth transition to new state
  </action>
  <verify>
Start frontend dev server, navigate to Aggregations page Phenotypes tab, observe:
1. Bars animate from left (width 0) to full width
2. Animation is staggered by row
3. Enable reduced motion - bars appear instantly
  </verify>
  <done>
StackedBarChart has staggered bar animation on load. Bars grow from baseline. Animation disabled when reduced motion preferred.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add export functionality and tests</name>
  <files>
    frontend/src/components/analyses/StackedBarChart.vue
    frontend/tests/components/analyses/StackedBarChart.test.js
  </files>
  <action>
1. Add export to StackedBarChart.vue:

Import:
```javascript
import { exportToPNG, exportToCSV, getTimestamp } from '@/utils/export';
import ChartExportMenu from '@/components/common/ChartExportMenu.vue';
```

Register component:
```javascript
components: {
  ChartExportMenu,
},
```

Update template:
```html
<template>
  <div class="stacked-bar-chart-container">
    <div class="chart-header">
      <ChartExportMenu
        @export-png="handleExportPNG"
        @export-csv="handleExportCSV"
      />
    </div>
    <div ref="chart" />
  </div>
</template>
```

Add methods:
```javascript
handleExportPNG() {
  const svg = this.$refs.chart.querySelector('svg');
  if (!svg) return;
  const filename = `phenotype-prevalence-${getTimestamp()}`;
  exportToPNG(svg, filename, 2);
},
handleExportCSV() {
  const aggregatedData = this.aggregateCKDStages(this.chartData);
  const limitedData = aggregatedData.slice(0, this.displayLimit);

  const data = limitedData.map(d => ({
    phenotype: d.label,
    hpo_id: d.details?.hpo_id || '',
    present_count: d.details?.present_count || 0,
    absent_count: d.details?.absent_count || 0,
    not_reported_count: d.details?.not_reported_count || 0,
    penetrance_percent: d.details && (d.details.present_count + d.details.absent_count) > 0
      ? ((d.details.present_count / (d.details.present_count + d.details.absent_count)) * 100).toFixed(1)
      : 'N/A'
  }));

  const filename = `phenotype-prevalence-${getTimestamp()}`;
  exportToCSV(data, ['phenotype', 'hpo_id', 'present_count', 'absent_count', 'not_reported_count', 'penetrance_percent'], filename);
},
```

Add CSS for chart-header:
```css
.chart-header {
  display: flex;
  justify-content: flex-end;
  margin-bottom: 8px;
}
```

2. Create/update test file:
- Test that ChartExportMenu is rendered
- Test handleExportPNG is called when export-png event fires
- Test handleExportCSV generates correct data structure
- Test accessibility attributes are present on SVG
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/StackedBarChart.test.js --run
  </verify>
  <done>
StackedBarChart has export menu. PNG exports at 2x resolution. CSV exports phenotype data with snake_case headers. Tests pass.
  </done>
</task>

</tasks>

<verification>
Run StackedBarChart tests:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/StackedBarChart.test.js --run
```

Verify lint:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint
```

Manual verification (dev server):
1. Navigate to Aggregations page, Phenotypes tab
2. Verify bars animate from left
3. Click Export menu, verify PNG and CSV work
4. Enable reduced motion, refresh, verify no animation
</verification>

<success_criteria>
- [ ] StackedBarChart has role="img" and aria-labelledby on SVG
- [ ] StackedBarChart has title and desc elements with generated description
- [ ] Bars animate from width 0 with staggered timing on load
- [ ] Animation respects prefers-reduced-motion
- [ ] Export menu renders with PNG and CSV options
- [ ] PNG export downloads at 2x resolution
- [ ] CSV export downloads with phenotype, hpo_id, counts, penetrance
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-chart-polish/05-03-SUMMARY.md`
</output>
