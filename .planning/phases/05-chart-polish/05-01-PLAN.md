---
phase: 05-chart-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/utils/export.js
  - frontend/src/utils/chartAccessibility.js
  - frontend/src/utils/chartAnimation.js
  - frontend/src/components/common/ChartExportMenu.vue
  - frontend/tests/utils/export.test.js
  - frontend/tests/utils/chartAccessibility.test.js
  - frontend/tests/utils/chartAnimation.test.js
  - frontend/tests/components/common/ChartExportMenu.test.js
autonomous: true

must_haves:
  truths:
    - "Export utilities can convert SVG to PNG at 2x resolution"
    - "Export utilities can generate CSV with snake_case headers"
    - "Animation utilities respect prefers-reduced-motion"
    - "Accessibility utilities generate screen reader descriptions"
    - "ChartExportMenu component renders PNG and CSV options"
  artifacts:
    - path: "frontend/src/utils/export.js"
      provides: "PNG and CSV export functions"
      exports: ["exportToPNG", "exportToCSV", "getTimestamp"]
    - path: "frontend/src/utils/chartAccessibility.js"
      provides: "ARIA and screen reader utilities"
      exports: ["addChartAccessibility", "generateDonutDescription", "generateBarChartDescription", "generateLineChartDescription"]
    - path: "frontend/src/utils/chartAnimation.js"
      provides: "Animation timing with reduced-motion support"
      exports: ["prefersReducedMotion", "getAnimationDuration", "getStaggerDelay"]
    - path: "frontend/src/components/common/ChartExportMenu.vue"
      provides: "Reusable export dropdown menu"
      min_lines: 30
  key_links:
    - from: "frontend/src/utils/export.js"
      to: "file-saver"
      via: "import { saveAs }"
      pattern: "import.*saveAs.*file-saver"
    - from: "frontend/src/utils/chartAnimation.js"
      to: "window.matchMedia"
      via: "prefers-reduced-motion check"
      pattern: "matchMedia.*prefers-reduced-motion"
---

<objective>
Create shared chart utilities for export, accessibility, and animation that will be used by all chart components in Phase 5.

Purpose: Establish DRY utilities before modifying individual charts, avoiding code duplication across 5+ components.
Output: Four new utility files with tests, ready for import by chart components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-chart-polish/05-CONTEXT.md
@.planning/phases/05-chart-polish/05-RESEARCH.md
@frontend/src/utils/designTokens.js
@frontend/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export utilities</name>
  <files>
    frontend/src/utils/export.js
    frontend/tests/utils/export.test.js
  </files>
  <action>
Create `frontend/src/utils/export.js` with these functions:

1. `exportToPNG(svgElement, filename, scale = 2)`:
   - Clone SVG element
   - Add white background rect as first child
   - Use XMLSerializer to convert to string
   - Create canvas at width*scale, height*scale
   - Fill canvas with white, scale context
   - Create Image, set src to SVG data URI (base64 encoded)
   - On image load, draw to canvas, call canvas.toBlob
   - Use saveAs from file-saver to download as `${filename}.png`

2. `exportToCSV(data, headers, filename)`:
   - Create header row by joining headers with comma
   - Map data array to rows, escaping values with quotes if they contain commas/quotes
   - Join all rows with newline
   - Create Blob with text/csv MIME type
   - Use saveAs to download as `${filename}.csv`

3. `getTimestamp()`:
   - Return new Date().toISOString().slice(0, 10) for YYYY-MM-DD format

Import `saveAs` from `file-saver` (already installed in package.json).

Create tests in `frontend/tests/utils/export.test.js`:
- Test getTimestamp returns valid date format
- Test exportToCSV generates correct CSV string structure (mock saveAs)
- Test exportToPNG handles missing SVG gracefully
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/utils/export.test.js --run
  </verify>
  <done>
export.js exports exportToPNG, exportToCSV, getTimestamp. Tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create accessibility and animation utilities</name>
  <files>
    frontend/src/utils/chartAccessibility.js
    frontend/src/utils/chartAnimation.js
    frontend/tests/utils/chartAccessibility.test.js
    frontend/tests/utils/chartAnimation.test.js
  </files>
  <action>
Create `frontend/src/utils/chartAccessibility.js`:

1. `addChartAccessibility(svg, titleId, descId, title, description)`:
   - Set svg role="img" and aria-labelledby="${titleId} ${descId}"
   - Insert title element with id=titleId and text content
   - Insert desc element with id=descId and text content
   - Parameters: svg is D3 selection, others are strings

2. `generateDonutDescription(data, total)`:
   - data is array of {label, count} objects
   - Return string: "Chart showing {total} total items. {label}: {count} ({pct}%). ..."
   - Format percentages to 1 decimal place

3. `generateBarChartDescription(data)`:
   - data is array of {label, present, absent} objects
   - Return string describing top 10 features with penetrance percentages
   - Include "and N more features" if data.length > 10

4. `generateLineChartDescription(groups)`:
   - groups is array of {name, n, events} objects (Kaplan-Meier format)
   - Return string describing survival curves and sample sizes

Create `frontend/src/utils/chartAnimation.js`:

1. `prefersReducedMotion()`:
   - Return window.matchMedia('(prefers-reduced-motion: reduce)').matches

2. `getAnimationDuration(defaultDuration = 400)`:
   - Return 0 if prefersReducedMotion(), otherwise defaultDuration

3. `getStaggerDelay(index, delayPerItem = 50)`:
   - Return 0 if prefersReducedMotion(), otherwise index * delayPerItem

Create tests for both utilities:
- chartAccessibility: Test description generators produce expected format
- chartAnimation: Test prefersReducedMotion detection (mock matchMedia), duration/delay functions
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/utils/chartAccessibility.test.js tests/utils/chartAnimation.test.js --run
  </verify>
  <done>
Both utilities export their functions. Tests pass. Animation utilities return 0 when reduced motion is preferred.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ChartExportMenu component</name>
  <files>
    frontend/src/components/common/ChartExportMenu.vue
    frontend/tests/components/common/ChartExportMenu.test.js
  </files>
  <action>
Create `frontend/src/components/common/ChartExportMenu.vue`:

Vue Options API component with:

Template:
- v-menu with activator slot containing v-btn (variant="outlined", size="small", color="primary")
- Button shows mdi-download icon + "Export" text
- Menu contains v-list with two v-list-item entries:
  - "Download PNG" with mdi-image icon, @click emits 'export-png'
  - "Download CSV" with mdi-file-delimited icon, @click emits 'export-csv' (conditionally rendered via v-if="showCsv")

Script:
- name: 'ChartExportMenu'
- props: showCsv (Boolean, default: true)
- emits: ['export-png', 'export-csv']

Style (scoped): minimal, rely on Vuetify defaults

Create tests in `frontend/tests/components/common/ChartExportMenu.test.js`:
- Test component renders export button
- Test clicking PNG option emits 'export-png'
- Test clicking CSV option emits 'export-csv'
- Test CSV option hidden when showCsv=false

Use shallowMount with Vuetify stubs (same pattern as DataTableToolbar.test.js from Phase 4).
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/common/ChartExportMenu.test.js --run
  </verify>
  <done>
ChartExportMenu.vue renders correctly. Emits export-png and export-csv events. Tests pass.
  </done>
</task>

</tasks>

<verification>
Run all new utility tests together:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/utils/export.test.js tests/utils/chartAccessibility.test.js tests/utils/chartAnimation.test.js tests/components/common/ChartExportMenu.test.js --run
```

Verify no lint errors:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint
```
</verification>

<success_criteria>
- [ ] export.js created with exportToPNG, exportToCSV, getTimestamp
- [ ] chartAccessibility.js created with addChartAccessibility, description generators
- [ ] chartAnimation.js created with prefersReducedMotion, getAnimationDuration, getStaggerDelay
- [ ] ChartExportMenu.vue created with PNG/CSV options, emits events
- [ ] All tests pass
- [ ] No lint errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-chart-polish/05-01-SUMMARY.md`
</output>
