---
phase: 05-chart-polish
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/components/analyses/KaplanMeierChart.vue
  - frontend/tests/components/analyses/KaplanMeierChart.test.js
autonomous: true

must_haves:
  truths:
    - "KaplanMeierChart has path drawing animation on survival curves"
    - "KaplanMeierChart animation is disabled when prefers-reduced-motion"
    - "KaplanMeierChart has screen reader description with group summaries"
    - "KaplanMeierChart has upgraded export with PNG option (in addition to existing SVG)"
    - "KaplanMeierChart has CSV export for survival data"
  artifacts:
    - path: "frontend/src/components/analyses/KaplanMeierChart.vue"
      provides: "Accessible, animated survival chart with export"
      contains: "aria-labelledby"
    - path: "frontend/tests/components/analyses/KaplanMeierChart.test.js"
      provides: "Tests for accessibility and export"
      min_lines: 40
  key_links:
    - from: "frontend/src/components/analyses/KaplanMeierChart.vue"
      to: "frontend/src/utils/chartAnimation.js"
      via: "import animation utilities"
      pattern: "import.*getAnimationDuration.*chartAnimation"
    - from: "frontend/src/components/analyses/KaplanMeierChart.vue"
      to: "frontend/src/utils/export.js"
      via: "import export utilities"
      pattern: "import.*exportToPNG.*export"
---

<objective>
Add accessibility, path drawing animation, and upgrade export functionality for KaplanMeierChart component.

Purpose: Fulfill A11Y-01, A11Y-02, A11Y-05, CHART-03, CHART-04, CHART-05, CHART-07, CHART-08, CHART-09 requirements for line charts.
Output: KaplanMeierChart.vue with ARIA attributes, path drawing animation, PNG/CSV export (upgrading existing SVG-only export).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-chart-polish/05-CONTEXT.md
@.planning/phases/05-chart-polish/05-RESEARCH.md
@.planning/phases/05-chart-polish/05-01-SUMMARY.md
@frontend/src/components/analyses/KaplanMeierChart.vue
@frontend/src/utils/chartAnimation.js
@frontend/src/utils/chartAccessibility.js
@frontend/src/utils/export.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add accessibility to KaplanMeierChart</name>
  <files>frontend/src/components/analyses/KaplanMeierChart.vue</files>
  <action>
Modify KaplanMeierChart.vue to add accessibility:

1. Import utilities at top of script:
```javascript
import { addChartAccessibility, generateLineChartDescription } from '@/utils/chartAccessibility';
```

2. In renderChart() after creating SVG:
- Generate unique IDs
- Generate description from groups data:
```javascript
const description = generateLineChartDescription(groups);
// generateLineChartDescription should output something like:
// "Survival analysis chart. Group 1 (Truncating): n=123, 45 events. Group 2 (Non-truncating): n=234, 67 events."
```
- Get root SVG: `const rootSvg = d3.select(this.$refs.chart).select('svg');`
- Call `addChartAccessibility(rootSvg, titleId, descId, 'Kaplan-Meier Survival Chart', description);`

3. Add aria-hidden="true" to decorative elements:
- Grid lines (.grid)
- Confidence interval bands
- Decorative markers (except interactive ones which have tooltips)

4. Keep axis labels and legend text accessible
  </action>
  <verify>
Manually inspect KaplanMeierChart.vue for:
- role="img" on SVG
- aria-labelledby attribute
- title and desc elements
  </verify>
  <done>
KaplanMeierChart has ARIA attributes. Screen readers can access chart description with group summaries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add path drawing animation</name>
  <files>frontend/src/components/analyses/KaplanMeierChart.vue</files>
  <action>
Modify KaplanMeierChart.vue to add path drawing animation using stroke-dasharray technique:

1. Import animation utilities:
```javascript
import { getAnimationDuration, prefersReducedMotion } from '@/utils/chartAnimation';
```

2. Modify survival curve drawing:

After drawing the curve path, add animation:
```javascript
const duration = getAnimationDuration(2000); // Longer for line charts per CONTEXT.md

// Draw the survival curve
const curvePath = svg
  .append('path')
  .datum(data)
  .attr('class', `survival-curve-${groupIndex}`)
  .attr('fill', 'none')
  .attr('stroke', color)
  .attr('stroke-width', 2.5)
  .attr('d', line)
  .attr('aria-hidden', 'true');

// Add path drawing animation
if (!prefersReducedMotion() && duration > 0) {
  const totalLength = curvePath.node().getTotalLength();

  curvePath
    .attr('stroke-dasharray', `${totalLength} ${totalLength}`)
    .attr('stroke-dashoffset', totalLength)
    .transition()
    .duration(duration)
    .ease(d3.easeLinear)
    .attr('stroke-dashoffset', 0);
}
```

3. Stagger animation across groups:
- Each group's curve starts slightly after the previous
- Use groupIndex * 300 as additional delay

4. Confidence bands should fade in (opacity transition) rather than path draw:
```javascript
if (!prefersReducedMotion()) {
  confidenceBand
    .attr('fill-opacity', 0)
    .transition()
    .delay(groupIndex * 300)
    .duration(duration / 2)
    .attr('fill-opacity', 0.15);
}
```

5. Event markers (circles) should fade in after curve completes
  </action>
  <verify>
Start frontend dev server, navigate to Survival Analysis page, observe:
1. Survival curves draw progressively
2. Multiple groups animate with stagger
3. Confidence bands fade in
4. Enable reduced motion - curves appear instantly
  </verify>
  <done>
KaplanMeierChart has path drawing animation. Curves draw progressively. Animation disabled when reduced motion preferred.
  </done>
</task>

<task type="auto">
  <name>Task 3: Upgrade export with PNG and CSV</name>
  <files>
    frontend/src/components/analyses/KaplanMeierChart.vue
    frontend/tests/components/analyses/KaplanMeierChart.test.js
  </files>
  <action>
1. Upgrade export in KaplanMeierChart.vue:

Import:
```javascript
import { exportToPNG, exportToCSV, getTimestamp } from '@/utils/export';
import ChartExportMenu from '@/components/common/ChartExportMenu.vue';
```

Register component:
```javascript
components: {
  ChartExportMenu,
},
```

Replace existing export button with ChartExportMenu in template:
```html
<div class="export-controls">
  <ChartExportMenu
    @export-png="handleExportPNG"
    @export-csv="handleExportCSV"
  />
  <!-- Keep existing SVG export button as separate option if desired -->
  <button class="export-btn" title="Download as SVG" @click="exportSVG">
    <span class="export-icon">mdi-file-image</span> SVG
  </button>
</div>
```

Add methods:
```javascript
handleExportPNG() {
  const svg = this.$refs.chart.querySelector('svg');
  if (!svg) return;
  const comparison = this.survivalData?.comparison_type || 'survival';
  const endpoint = this.survivalData?.endpoint?.replace(/\s+/g, '-').toLowerCase() || 'analysis';
  const filename = `kaplan-meier-${comparison}-${endpoint}-${getTimestamp()}`;
  exportToPNG(svg, filename, 2);
},

handleExportCSV() {
  if (!this.survivalData?.groups) return;

  // Flatten survival data for all groups
  const data = [];
  this.survivalData.groups.forEach(group => {
    group.survival_data.forEach(point => {
      data.push({
        group_name: group.name,
        time_years: point.time,
        survival_probability: point.survival_probability.toFixed(4),
        ci_lower: point.ci_lower?.toFixed(4) ?? '',
        ci_upper: point.ci_upper?.toFixed(4) ?? '',
        at_risk: point.at_risk,
        events: point.events,
        censored: point.censored
      });
    });
  });

  const comparison = this.survivalData?.comparison_type || 'survival';
  const filename = `kaplan-meier-${comparison}-${getTimestamp()}`;
  exportToCSV(data, [
    'group_name', 'time_years', 'survival_probability',
    'ci_lower', 'ci_upper', 'at_risk', 'events', 'censored'
  ], filename);
},
```

2. Create/update test file:
- Test that ChartExportMenu is rendered
- Test handleExportPNG is called when export-png event fires
- Test handleExportCSV generates correct data structure with all groups
- Test accessibility attributes are present on SVG
  </action>
  <verify>
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/KaplanMeierChart.test.js --run
  </verify>
  <done>
KaplanMeierChart has ChartExportMenu. PNG and CSV exports work. SVG export preserved. Tests pass.
  </done>
</task>

</tasks>

<verification>
Run KaplanMeierChart tests:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm test -- tests/components/analyses/KaplanMeierChart.test.js --run
```

Verify lint:
```bash
cd /home/bernt-popp/development/hnf1b-db/frontend && npm run lint
```

Manual verification (dev server):
1. Navigate to Survival Analysis page
2. Verify curves draw progressively
3. Test all three export options (PNG, CSV, SVG)
4. Enable reduced motion, refresh, verify no animation
</verification>

<success_criteria>
- [ ] KaplanMeierChart has role="img" and aria-labelledby on SVG
- [ ] KaplanMeierChart has title and desc elements with group summaries
- [ ] Survival curves animate with path drawing effect
- [ ] Animation respects prefers-reduced-motion
- [ ] Export menu has PNG, CSV options (plus existing SVG button)
- [ ] PNG export downloads at 2x resolution
- [ ] CSV export downloads with all survival data points
- [ ] All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-chart-polish/05-04-SUMMARY.md`
</output>
