---
phase: 03-backend-test-modernization
plan: 07
type: execute
wave: 3
depends_on: ["03-02", "03-03", "03-04", "03-05", "03-06"]
files_modified:
  - backend/tests/conftest.py
  - backend/tests/test_rate_limiting.py
autonomous: true

must_haves:
  truths:
    - "Backward-compatibility aliases removed from conftest.py"
    - "All tests use fixture_ prefix directly"
    - "All 747 tests pass"
    - "No deprecated patterns remain"
  artifacts:
    - path: "backend/tests/conftest.py"
      provides: "Clean conftest without aliases"
      contains: "fixture_db_session"
  key_links:
    - from: "backend/tests/*.py"
      to: "backend/tests/conftest.py"
      via: "direct fixture_ imports"
      pattern: "fixture_"
---

<objective>
Finalize test migration: Remove backward-compat aliases, migrate remaining file, verify full suite

Purpose: Complete the test modernization by removing backward-compatibility aliases from conftest.py and migrating the last remaining test file. Run full test suite to verify all 747 tests pass.

Output: Clean conftest.py without aliases, all tests using fixture_ prefix directly, full test suite passing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-02-SUMMARY.md
@.planning/phases/03-backend-test-modernization/03-03-SUMMARY.md
@.planning/phases/03-backend-test-modernization/03-04-SUMMARY.md
@.planning/phases/03-backend-test-modernization/03-05-SUMMARY.md
@.planning/phases/03-backend-test-modernization/03-06-SUMMARY.md
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_rate_limiting.py (last remaining file)</name>
  <files>backend/tests/test_rate_limiting.py</files>
  <action>
Rename tests in the last remaining test file:

**test_rate_limiting.py** - Rename tests:
- `test_rate_limiter_init` -> `test_rate_limiting_init_creates_limiter`
- `test_rate_limiter_allows_under_limit` -> `test_rate_limiting_allows_requests_under_limit`
- `test_rate_limiter_blocks_over_limit` -> `test_rate_limiting_blocks_requests_over_limit`
- `test_rate_limiter_resets_after_window` -> `test_rate_limiting_resets_after_time_window`
- Similar for all rate limiting tests

Update fixture references to use `fixture_` prefix.

Verify all tests pass after migration.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_rate_limiting.py -v 2>&1 | tail -20
```
  </verify>
  <done>test_rate_limiting.py migrated with new naming, all tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Remove backward-compatibility aliases from conftest.py</name>
  <files>backend/tests/conftest.py</files>
  <action>
Remove all backward-compatibility aliases from the end of conftest.py:

Delete these lines:
```python
# Backward-compatibility aliases (remove after test migration complete)
db_session = fixture_db_session
test_user = fixture_test_user
admin_user = fixture_admin_user
async_client = fixture_async_client
auth_headers = fixture_auth_headers
admin_headers = fixture_admin_headers
cleanup_test_phenopackets = fixture_cleanup_test_phenopackets
sample_phenopacket_minimal = fixture_sample_phenopacket_minimal
sample_phenopacket_with_data = fixture_sample_phenopacket_with_data
valid_phenopacket_data = fixture_valid_phenopacket_data
invalid_phenopacket_data = fixture_invalid_phenopacket_data
```

All tests should now use `fixture_` prefix directly. If any test fails due to missing fixture, update that test file to use the correct fixture name.

Run the full test suite to verify all tests still pass.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
# Verify aliases are removed
grep "^db_session = fixture" tests/conftest.py && echo "FAIL: aliases still present" || echo "PASS: aliases removed"

# Run full test suite
uv run pytest -q 2>&1 | tail -5
```
  </verify>
  <done>Backward-compat aliases removed, all tests use fixture_ prefix directly, full suite passing</done>
</task>

<task type="auto">
  <name>Task 3: Verify full test suite and run coverage report</name>
  <files></files>
  <action>
Run the complete test suite with coverage to verify:
1. All 747 tests pass
2. Coverage meets 60% minimum threshold
3. No deprecated patterns remain

Commands:
```bash
cd /home/bernt-popp/development/hnf1b-db/backend

# Full test suite
uv run pytest -q 2>&1

# Coverage report
uv run pytest --cov=app --cov-report=term-missing 2>&1 | tail -50

# Check for any remaining old fixture names in test files
grep -r "def test_.*async_client[^_]" tests/ | head -10
grep -r "def test_.*db_session[^_]" tests/ | head -10
```

Record:
- Total tests passed
- Coverage percentage
- Any files below 40% coverage threshold

If coverage is below 60%, document which files need additional tests (to be addressed in a future plan if needed).
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest -q 2>&1 | tail -3
# Should show "747 passed" or similar
```
  </verify>
  <done>Full test suite passes (747 tests), coverage percentage recorded, no deprecated patterns remain</done>
</task>

</tasks>

<verification>
- [ ] `grep "^db_session = " backend/tests/conftest.py` returns no matches (aliases removed)
- [ ] `cd backend && uv run pytest -q` shows all tests passing
- [ ] `cd backend && uv run pytest --cov=app -q` runs without errors
- [ ] No test files use old fixture names without `fixture_` prefix
</verification>

<success_criteria>
1. test_rate_limiting.py migrated with new naming
2. All backward-compat aliases removed from conftest.py
3. All 747 tests pass using `fixture_` prefix fixtures
4. Coverage report generated and threshold documented
5. No deprecated unittest.mock patterns remain (verified)
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-07-SUMMARY.md`
</output>
