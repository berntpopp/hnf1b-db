---
phase: 03-backend-test-modernization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pyproject.toml
  - backend/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "pytest-cov generates coverage reports when running tests"
    - "Coverage excludes alembic/versions/ and __init__.py files"
    - "All conftest.py fixtures have fixture_ prefix"
    - "Existing tests still pass with backward-compat aliases"
  artifacts:
    - path: "backend/pyproject.toml"
      provides: "[tool.coverage.*] configuration sections"
      contains: "fail_under = 60"
    - path: "backend/tests/conftest.py"
      provides: "Renamed fixtures with fixture_ prefix"
      contains: "fixture_db_session"
  key_links:
    - from: "backend/pyproject.toml"
      to: "pytest-cov"
      via: "[tool.coverage.run] source setting"
      pattern: 'source = \["app"\]'
    - from: "backend/tests/conftest.py"
      to: "all test files"
      via: "backward-compat aliases"
      pattern: "db_session = fixture_db_session"
---

<objective>
Configure pytest-cov and modernize conftest.py fixture naming

Purpose: Establish coverage measurement baseline and standardize fixture naming conventions per CONTEXT.md decisions. This foundation enables subsequent test file migrations.

Output: Updated pyproject.toml with coverage configuration, conftest.py with renamed fixtures and backward-compatibility aliases.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-RESEARCH.md
@backend/pyproject.toml
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add coverage configuration to pyproject.toml</name>
  <files>backend/pyproject.toml</files>
  <action>
Add pytest-cov configuration sections to pyproject.toml:

```toml
[tool.coverage.run]
branch = true
source = ["app"]
omit = [
    "*/alembic/versions/*",
    "*/__init__.py",
]

[tool.coverage.report]
exclude_also = [
    "def __repr__",
    "raise NotImplementedError",
    "if TYPE_CHECKING:",
    "@(abc\\.)?abstractmethod",
]
fail_under = 60
show_missing = true

[tool.coverage.html]
skip_empty = true
```

Per CONTEXT.md: 60% overall minimum, report-only in CI (no build failure), terminal output only.

Place after existing [tool.ruff.*] sections.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
grep -A 5 "\[tool.coverage.run\]" pyproject.toml
```
  </verify>
  <done>pyproject.toml contains [tool.coverage.run], [tool.coverage.report], [tool.coverage.html] sections with correct settings</done>
</task>

<task type="auto">
  <name>Task 2: Rename conftest.py fixtures with fixture_ prefix</name>
  <files>backend/tests/conftest.py</files>
  <action>
Rename all 7 fixtures in conftest.py to use `fixture_` prefix:

| Current Name | New Name |
|--------------|----------|
| db_session | fixture_db_session |
| test_user | fixture_test_user |
| admin_user | fixture_admin_user |
| async_client | fixture_async_client |
| auth_headers | fixture_auth_headers |
| admin_headers | fixture_admin_headers |
| cleanup_test_phenopackets | fixture_cleanup_test_phenopackets |

Update all internal references within conftest.py (e.g., `fixture_test_user(fixture_db_session)` instead of `test_user(db_session)`).

Add backward-compatibility aliases at the end of the file:

```python
# Backward-compatibility aliases (remove after test migration complete)
db_session = fixture_db_session
test_user = fixture_test_user
admin_user = fixture_admin_user
async_client = fixture_async_client
auth_headers = fixture_auth_headers
admin_headers = fixture_admin_headers
cleanup_test_phenopackets = fixture_cleanup_test_phenopackets
```

This allows existing tests to continue working during gradual migration.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
# Check new fixture names exist
grep "async def fixture_" tests/conftest.py | wc -l
# Should be 7

# Check backward-compat aliases exist
grep "^db_session = fixture_db_session" tests/conftest.py
```
  </verify>
  <done>conftest.py has 7 fixtures with fixture_ prefix, backward-compat aliases at end, all internal references updated</done>
</task>

<task type="auto">
  <name>Task 3: Verify all existing tests still pass</name>
  <files></files>
  <action>
Run the full test suite to confirm backward-compatibility aliases work:

```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest -v --tb=short 2>&1 | tail -30
```

If any tests fail due to fixture name changes, add missing aliases or fix references.

Also run a quick coverage report to establish baseline:

```bash
uv run pytest --cov=app --cov-report=term-missing -q 2>&1 | tail -20
```

Record the baseline coverage percentage in the summary.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest -q 2>&1 | tail -3
# Should show "X passed" with no failures
```
  </verify>
  <done>All 747 tests pass, baseline coverage percentage recorded</done>
</task>

</tasks>

<verification>
- [ ] `grep "\[tool.coverage" backend/pyproject.toml` shows 3 sections
- [ ] `grep "fixture_db_session" backend/tests/conftest.py` returns matches
- [ ] `grep "^db_session = " backend/tests/conftest.py` shows backward-compat alias
- [ ] `cd backend && uv run pytest -q` shows all tests passing
- [ ] `cd backend && uv run pytest --cov=app -q` runs without errors
</verification>

<success_criteria>
1. pyproject.toml has [tool.coverage.run/report/html] sections configured per CONTEXT.md
2. All 7 conftest.py fixtures renamed to fixture_ prefix
3. Backward-compatibility aliases present for gradual migration
4. All existing tests pass (747 tests)
5. Coverage report runs successfully and baseline is recorded
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-01-SUMMARY.md`
</output>
