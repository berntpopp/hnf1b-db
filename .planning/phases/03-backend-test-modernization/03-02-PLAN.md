---
phase: 03-backend-test-modernization
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/tests/test_auth.py
  - backend/tests/test_config.py
  - backend/tests/test_phenopackets.py
  - backend/tests/test_ontology_autocomplete.py
  - backend/tests/test_ontology_service.py
  - backend/tests/test_cursor_pagination.py
autonomous: true

must_haves:
  truths:
    - "All test functions follow test_<feature>_<scenario>_<expected> naming"
    - "Fixtures use fixture_ prefix (no backward-compat aliases used)"
    - "Tests are organized in classes when related"
    - "All migrated tests pass"
  artifacts:
    - path: "backend/tests/test_auth.py"
      provides: "Renamed auth tests"
      contains: "test_auth_login_valid_credentials_returns_token"
    - path: "backend/tests/test_config.py"
      provides: "Renamed config tests"
      contains: "test_config_jwt_secret_empty_raises_error"
  key_links:
    - from: "backend/tests/test_auth.py"
      to: "backend/tests/conftest.py"
      via: "fixture imports"
      pattern: "fixture_async_client"
---

<objective>
Migrate test naming in Batch 1: Simple test files (auth, config, phenopackets, ontology, pagination)

Purpose: Systematically rename tests in smaller, simpler test files to follow the `test_<feature>_<scenario>_<expected>` convention. These files have fewer tests and no complex local fixtures.

Output: 6 test files with modernized naming conventions using fixture_ prefix fixtures.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-RESEARCH.md
@.planning/phases/03-backend-test-modernization/03-01-SUMMARY.md
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_auth.py naming and fixtures</name>
  <files>backend/tests/test_auth.py</files>
  <action>
Rename all test functions to follow `test_<feature>_<scenario>_<expected>` pattern:

| Current Name | New Name |
|--------------|----------|
| test_login_success | test_auth_login_valid_credentials_returns_token |
| test_login_invalid_credentials | test_auth_login_wrong_password_returns_401 |
| test_login_nonexistent_user | test_auth_login_unknown_user_returns_401 |
| test_get_current_user | test_auth_me_valid_token_returns_user_info |
| test_get_current_user_no_token | test_auth_me_no_token_returns_403 |
| test_token_refresh | test_auth_refresh_valid_token_returns_new_tokens |
| test_logout | test_auth_logout_valid_session_returns_success |
| test_change_password | test_auth_password_change_valid_current_succeeds |
| test_list_roles | test_auth_roles_authenticated_user_returns_all_roles |
| test_create_user_admin | test_auth_create_user_admin_role_succeeds |
| test_create_user_non_admin | test_auth_create_user_non_admin_returns_403 |
| test_list_users_admin | test_auth_list_users_admin_role_returns_list |
| test_delete_user_self | test_auth_delete_self_returns_400 |

Update fixture references from old names to `fixture_` prefix:
- `async_client` -> `fixture_async_client`
- `test_user` -> `fixture_test_user`
- `auth_headers` -> `fixture_auth_headers`
- `admin_headers` -> `fixture_admin_headers`
- `admin_user` -> `fixture_admin_user`
- `db_session` -> `fixture_db_session`

Keep class organization if tests are related. Add/update docstrings to describe the test scenario.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_auth.py -v 2>&1 | head -25
# Check all tests have new names and pass
```
  </verify>
  <done>test_auth.py has 13 tests with test_auth_<scenario>_<expected> naming, all using fixture_ prefix fixtures, all passing</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_config.py, test_phenopackets.py, test_cursor_pagination.py</name>
  <files>
    backend/tests/test_config.py
    backend/tests/test_phenopackets.py
    backend/tests/test_cursor_pagination.py
  </files>
  <action>
**test_config.py** - Rename tests within existing classes:

```
TestJWTSecretValidation:
  test_jwt_secret_validation_fails_on_empty_string -> test_config_jwt_secret_empty_raises_error
  test_jwt_secret_validation_fails_on_whitespace -> test_config_jwt_secret_whitespace_raises_error
  test_jwt_secret_validation_succeeds_with_valid_secret -> test_config_jwt_secret_valid_succeeds
  test_jwt_secret_validation_succeeds_with_strong_secret -> test_config_jwt_secret_strong_succeeds
  test_jwt_secret_validation_logs_critical_error -> test_config_jwt_secret_empty_logs_critical

TestCORSConfiguration:
  test_cors_origins_string_conversion -> test_config_cors_origins_list_converts_to_string
  test_cors_origins_list_parsing -> test_config_cors_origins_string_parses_to_list

TestDatabaseConfiguration:
  test_database_url_can_be_set -> test_config_database_url_custom_value_accepted
  test_old_database_url_optional -> test_config_old_database_url_none_accepted

TestYAMLConfiguration:
  test_pagination_defaults -> test_config_pagination_defaults_sensible_values
  test_external_apis_vep_defaults -> test_config_vep_api_defaults_ensembl_url
  test_external_apis_pubmed_defaults -> test_config_pubmed_api_defaults_ncbi_url
  test_rate_limiting_defaults -> test_config_rate_limiting_defaults_positive_values
  test_legacy_property_aliases -> test_config_legacy_properties_map_to_yaml
```

**test_phenopackets.py** - Rename tests:
```
test_phenopackets -> test_phenopackets_create_valid_structure_succeeds
test_pronto_hpo -> test_phenopackets_pronto_import_succeeds
test_jsonpath -> test_phenopackets_jsonpath_query_finds_hpo_terms
test_vrs -> test_phenopackets_vrs_models_create_location
```

**test_cursor_pagination.py** - Rename tests:
```
test_cursor_pagination_basic -> test_pagination_cursor_basic_navigation_works
test_cursor_pagination_empty -> test_pagination_cursor_empty_result_returns_none
```

No fixture updates needed for test_config.py (uses no shared fixtures).
test_phenopackets.py and test_cursor_pagination.py have no shared fixtures either.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_config.py tests/test_phenopackets.py tests/test_cursor_pagination.py -v 2>&1 | tail -20
```
  </verify>
  <done>3 test files migrated with new naming conventions, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Migrate test_ontology_autocomplete.py and test_ontology_service.py</name>
  <files>
    backend/tests/test_ontology_autocomplete.py
    backend/tests/test_ontology_service.py
  </files>
  <action>
**test_ontology_autocomplete.py** - Rename tests to follow pattern:
- `test_hpo_autocomplete_basic` -> `test_ontology_hpo_autocomplete_basic_query_returns_matches`
- `test_hpo_autocomplete_limit` -> `test_ontology_hpo_autocomplete_limit_param_caps_results`
- `test_hpo_autocomplete_no_match` -> `test_ontology_hpo_autocomplete_nonexistent_term_returns_empty`
- Similar pattern for remaining tests in file

Update fixture references if using shared fixtures.

**test_ontology_service.py** - Rename tests:
- Review each test and rename following `test_ontology_<feature>_<scenario>_<expected>` pattern
- Update fixture references to use `fixture_` prefix where applicable

Keep class organization intact. Update docstrings to reflect new names.

Run tests after each file to catch any issues early.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_ontology_autocomplete.py tests/test_ontology_service.py -v 2>&1 | tail -20
```
  </verify>
  <done>2 ontology test files migrated with new naming conventions, all tests passing</done>
</task>

</tasks>

<verification>
- [ ] `grep "test_auth_" backend/tests/test_auth.py | wc -l` shows 13+ matches
- [ ] `grep "test_config_" backend/tests/test_config.py | wc -l` shows 14+ matches
- [ ] `grep "test_phenopackets_" backend/tests/test_phenopackets.py | wc -l` shows 4 matches
- [ ] `grep "test_ontology_" backend/tests/test_ontology_*.py | wc -l` shows matches
- [ ] `cd backend && uv run pytest tests/test_auth.py tests/test_config.py tests/test_phenopackets.py tests/test_cursor_pagination.py tests/test_ontology_*.py -q` all pass
</verification>

<success_criteria>
1. All 6 test files use `test_<feature>_<scenario>_<expected>` naming
2. test_auth.py uses `fixture_` prefix fixtures (not backward-compat aliases)
3. All migrated tests pass
4. No regressions in other tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-02-SUMMARY.md`
</output>
