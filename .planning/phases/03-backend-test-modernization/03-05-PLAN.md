---
phase: 03-backend-test-modernization
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/tests/test_variant_validator_enhanced.py
  - backend/tests/test_variant_validator_api_integration.py
  - backend/tests/test_variant_annotation_vep.py
  - backend/tests/test_variant_search.py
  - backend/tests/test_variant_service_cnv.py
  - backend/tests/test_cnv_parser.py
  - backend/tests/test_cnv_annotation.py
autonomous: true

must_haves:
  truths:
    - "All test functions follow test_<feature>_<scenario>_<expected> naming"
    - "Fixtures use fixture_ prefix"
    - "All migrated tests pass"
  artifacts:
    - path: "backend/tests/test_variant_validator_enhanced.py"
      provides: "Renamed variant validator tests"
      contains: "test_variant_"
    - path: "backend/tests/test_cnv_parser.py"
      provides: "Renamed CNV tests"
      contains: "test_cnv_"
  key_links:
    - from: "backend/tests/test_variant_*.py"
      to: "backend/tests/conftest.py"
      via: "shared fixtures"
      pattern: "fixture_async_client"
---

<objective>
Migrate test naming in Batch 4: Variant and CNV test files

Purpose: Migrate the largest group of related tests - variant validation, annotation, search, and CNV handling. These files contain ~200+ tests total.

Output: 7 variant/CNV test files with modernized naming conventions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-RESEARCH.md
@.planning/phases/03-backend-test-modernization/03-01-SUMMARY.md
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_variant_validator_enhanced.py (largest file)</name>
  <files>backend/tests/test_variant_validator_enhanced.py</files>
  <action>
This is the largest test file (~1660 lines, ~150+ tests). Rename tests following pattern:

Classes and their tests:
- TestVariantValidator: `test_init` -> `test_variant_validator_init_creates_instance`
- TestHGVSValidation: `test_valid_hgvs_c` -> `test_variant_hgvs_c_valid_format_passes`
- TestGenomicValidation: `test_valid_genomic` -> `test_variant_genomic_valid_format_passes`
- TestSPDIValidation: `test_valid_spdi` -> `test_variant_spdi_valid_format_passes`
- TestVCFValidation: `test_valid_vcf` -> `test_variant_vcf_valid_format_passes`
- TestRSIDValidation: `test_valid_rsid` -> `test_variant_rsid_valid_format_passes`
- TestConfigurableSettings: `test_retry_config` -> `test_variant_config_retry_from_settings`

Pattern for each test: `test_variant_<validator>_<input_type>_<expected_outcome>`

Update all fixture references to use `fixture_` prefix.

Note: This file has many local fixtures (mock responses, sample data). Keep truly file-specific fixtures local, but rename with `fixture_` prefix if they're defined as pytest fixtures.

Work through the file systematically class by class.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_variant_validator_enhanced.py -v 2>&1 | tail -30
# Should show renamed tests passing
```
  </verify>
  <done>test_variant_validator_enhanced.py fully migrated with test_variant_ naming, all ~150 tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_variant_annotation_vep.py and test_variant_validator_api_integration.py</name>
  <files>
    backend/tests/test_variant_annotation_vep.py
    backend/tests/test_variant_validator_api_integration.py
  </files>
  <action>
**test_variant_annotation_vep.py** - Rename tests:
- `test_vep_annotation_basic` -> `test_variant_vep_annotation_basic_query_returns_data`
- `test_vep_annotation_with_cadd` -> `test_variant_vep_annotation_cadd_scores_present`
- `test_vep_annotation_caching` -> `test_variant_vep_annotation_cached_response_faster`
- `test_vep_rate_limiting` -> `test_variant_vep_rate_limit_throttles_requests`
- Similar for all VEP tests

**test_variant_validator_api_integration.py** - Rename tests:
- `test_validate_endpoint_hgvs` -> `test_variant_api_validate_hgvs_returns_200`
- `test_validate_endpoint_genomic` -> `test_variant_api_validate_genomic_returns_200`
- `test_annotate_endpoint` -> `test_variant_api_annotate_returns_vep_data`
- `test_recode_endpoint` -> `test_variant_api_recode_converts_formats`
- Similar for all API integration tests

Update fixture references to use `fixture_` prefix.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_variant_annotation_vep.py tests/test_variant_validator_api_integration.py -v 2>&1 | tail -25
```
  </verify>
  <done>VEP and API integration test files migrated, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Migrate CNV and variant search tests</name>
  <files>
    backend/tests/test_variant_search.py
    backend/tests/test_variant_service_cnv.py
    backend/tests/test_cnv_parser.py
    backend/tests/test_cnv_annotation.py
  </files>
  <action>
**test_variant_search.py** - Rename tests:
- `test_search_by_hgvs` -> `test_variant_search_hgvs_query_returns_matches`
- `test_search_by_rsid` -> `test_variant_search_rsid_query_returns_matches`
- `test_search_pagination` -> `test_variant_search_pagination_returns_correct_page`
- Similar for all search tests

**test_variant_service_cnv.py** - Rename tests:
- `test_cnv_detection` -> `test_cnv_service_detects_copy_number_variant`
- `test_cnv_annotation` -> `test_cnv_service_annotates_with_genes`
- Similar for all CNV service tests

**test_cnv_parser.py** - Rename tests:
- `test_parse_deletion` -> `test_cnv_parser_deletion_format_parses_correctly`
- `test_parse_duplication` -> `test_cnv_parser_duplication_format_parses_correctly`
- Similar for all parser tests

**test_cnv_annotation.py** - Rename tests:
- `test_annotate_cnv` -> `test_cnv_annotation_returns_gene_overlap`
- `test_annotate_cnv_no_overlap` -> `test_cnv_annotation_no_genes_returns_empty`
- Similar for all annotation tests

Update all fixture references to use `fixture_` prefix.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_variant_search.py tests/test_variant_service_cnv.py tests/test_cnv_parser.py tests/test_cnv_annotation.py -v 2>&1 | tail -25
```
  </verify>
  <done>CNV and variant search test files migrated, all tests passing</done>
</task>

</tasks>

<verification>
- [ ] `grep "test_variant_" backend/tests/test_variant_validator_enhanced.py | wc -l` shows 150+ matches
- [ ] `grep "test_variant_" backend/tests/test_variant_*.py | wc -l` shows substantial matches
- [ ] `grep "test_cnv_" backend/tests/test_cnv_*.py | wc -l` shows substantial matches
- [ ] `cd backend && uv run pytest tests/test_variant_*.py tests/test_cnv_*.py -q` all pass
</verification>

<success_criteria>
1. All 7 test files use `test_<feature>_<scenario>_<expected>` naming
2. All files use `fixture_` prefix fixtures
3. All ~200+ migrated tests pass
4. No regressions in other tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-05-SUMMARY.md`
</output>
