---
phase: 03-backend-test-modernization
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/tests/test_json_api_integration.py
  - backend/tests/test_json_api_pagination.py
  - backend/tests/test_global_search.py
  - backend/tests/test_search_endpoint_enhanced.py
  - backend/tests/test_race_condition_fix.py
  - backend/tests/test_index_performance_benchmark.py
autonomous: true

must_haves:
  truths:
    - "All test functions follow test_<feature>_<scenario>_<expected> naming"
    - "Fixtures use fixture_ prefix"
    - "All migrated tests pass"
  artifacts:
    - path: "backend/tests/test_json_api_integration.py"
      provides: "Renamed JSON:API tests"
      contains: "test_jsonapi_"
    - path: "backend/tests/test_global_search.py"
      provides: "Renamed search tests"
      contains: "test_search_"
  key_links:
    - from: "backend/tests/test_json_api_*.py"
      to: "backend/tests/conftest.py"
      via: "shared fixtures"
      pattern: "fixture_async_client"
---

<objective>
Migrate test naming in Batch 3: Integration and search test files

Purpose: Migrate the JSON:API, search, and performance test files. These are larger files with integration tests that exercise multiple components.

Output: 6 test files with modernized naming conventions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-RESEARCH.md
@.planning/phases/03-backend-test-modernization/03-01-SUMMARY.md
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_json_api_integration.py and test_json_api_pagination.py</name>
  <files>
    backend/tests/test_json_api_integration.py
    backend/tests/test_json_api_pagination.py
  </files>
  <action>
**test_json_api_integration.py** - Rename tests following pattern:
- `test_list_endpoint_format` -> `test_jsonapi_list_endpoint_returns_valid_format`
- `test_detail_endpoint_format` -> `test_jsonapi_detail_endpoint_returns_valid_format`
- `test_pagination_links` -> `test_jsonapi_pagination_links_present_in_response`
- `test_filter_parameter` -> `test_jsonapi_filter_param_filters_results`
- Similar for all tests

Update fixture references to use `fixture_` prefix:
- `async_client` -> `fixture_async_client`
- `db_session` -> `fixture_db_session`
- `auth_headers` -> `fixture_auth_headers`

**test_json_api_pagination.py** - Rename tests:
- `test_offset_pagination` -> `test_jsonapi_offset_pagination_returns_correct_page`
- `test_cursor_pagination` -> `test_jsonapi_cursor_pagination_returns_next_link`
- `test_pagination_meta` -> `test_jsonapi_pagination_meta_contains_total_count`
- Similar for all pagination tests

Keep class organization if present. Update docstrings.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_json_api_integration.py tests/test_json_api_pagination.py -v 2>&1 | tail -25
```
  </verify>
  <done>JSON:API test files migrated with test_jsonapi_ prefix naming, fixture_ prefix fixtures, all tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_global_search.py and test_search_endpoint_enhanced.py</name>
  <files>
    backend/tests/test_global_search.py
    backend/tests/test_search_endpoint_enhanced.py
  </files>
  <action>
**test_global_search.py** - Rename tests following pattern:
- `test_search_by_subject_id` -> `test_search_global_by_subject_id_returns_matches`
- `test_search_by_hpo_term` -> `test_search_global_by_hpo_term_returns_matches`
- `test_search_pagination` -> `test_search_global_pagination_returns_correct_page`
- `test_search_no_results` -> `test_search_global_nonexistent_query_returns_empty`
- Similar for all tests (~30+ tests)

**test_search_endpoint_enhanced.py** - Rename tests:
- `test_enhanced_search_filters` -> `test_search_enhanced_filters_apply_correctly`
- `test_enhanced_search_sorting` -> `test_search_enhanced_sorting_orders_results`
- `test_enhanced_search_facets` -> `test_search_enhanced_facets_return_counts`
- Similar for all enhanced search tests

Update fixture references to use `fixture_` prefix for both files.
Keep class organization if present.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_global_search.py tests/test_search_endpoint_enhanced.py -v 2>&1 | tail -25
```
  </verify>
  <done>Search test files migrated with test_search_ prefix naming, fixture_ prefix fixtures, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Migrate test_race_condition_fix.py and test_index_performance_benchmark.py</name>
  <files>
    backend/tests/test_race_condition_fix.py
    backend/tests/test_index_performance_benchmark.py
  </files>
  <action>
**test_race_condition_fix.py** - Rename tests:
- `test_concurrent_creates` -> `test_concurrency_create_parallel_requests_no_race`
- `test_concurrent_updates` -> `test_concurrency_update_parallel_requests_no_race`
- `test_transaction_isolation` -> `test_concurrency_transaction_isolation_prevents_dirty_read`
- Similar for all concurrency tests

**test_index_performance_benchmark.py** - Rename tests:
- `test_index_exists` -> `test_performance_index_exists_on_table`
- `test_query_uses_index` -> `test_performance_query_plan_uses_index`
- `test_bulk_insert_performance` -> `test_performance_bulk_insert_under_threshold`
- Similar for all benchmark tests

These files may have specific performance fixtures - keep those local if they're not reusable elsewhere.

Update fixture references to use `fixture_` prefix where applicable.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_race_condition_fix.py tests/test_index_performance_benchmark.py -v 2>&1 | tail -25
```
  </verify>
  <done>Concurrency and performance test files migrated, all tests passing</done>
</task>

</tasks>

<verification>
- [ ] `grep "test_jsonapi_" backend/tests/test_json_api_*.py | wc -l` shows substantial matches
- [ ] `grep "test_search_" backend/tests/test_global_search.py backend/tests/test_search_endpoint_enhanced.py | wc -l` shows substantial matches
- [ ] `grep "test_concurrency_" backend/tests/test_race_condition_fix.py | wc -l` shows matches
- [ ] `grep "test_performance_" backend/tests/test_index_performance_benchmark.py | wc -l` shows matches
- [ ] `cd backend && uv run pytest tests/test_json_api_*.py tests/test_global_search.py tests/test_search_endpoint_enhanced.py tests/test_race_condition_fix.py tests/test_index_performance_benchmark.py -q` all pass
</verification>

<success_criteria>
1. All 6 test files use `test_<feature>_<scenario>_<expected>` naming
2. All files use `fixture_` prefix fixtures
3. All migrated tests pass
4. No regressions in other tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-04-SUMMARY.md`
</output>
