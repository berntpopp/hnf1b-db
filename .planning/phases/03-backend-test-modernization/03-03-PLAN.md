---
phase: 03-backend-test-modernization
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/tests/test_audit_utils.py
  - backend/tests/test_audit_logging.py
  - backend/tests/test_patterns.py
  - backend/tests/test_batch_endpoints.py
  - backend/tests/test_transaction_management.py
  - backend/tests/conftest.py
autonomous: true

must_haves:
  truths:
    - "All test functions follow test_<feature>_<scenario>_<expected> naming"
    - "Reusable fixtures consolidated in conftest.py"
    - "Local fixtures only for truly file-specific data"
    - "All migrated tests pass"
  artifacts:
    - path: "backend/tests/test_audit_utils.py"
      provides: "Renamed audit tests"
      contains: "test_audit_"
    - path: "backend/tests/conftest.py"
      provides: "Consolidated sample_phenopacket fixtures"
      contains: "fixture_sample_phenopacket_minimal"
  key_links:
    - from: "backend/tests/test_audit_utils.py"
      to: "backend/tests/conftest.py"
      via: "shared phenopacket fixtures"
      pattern: "fixture_sample_phenopacket"
---

<objective>
Migrate test naming in Batch 2: Utility test files with shared fixtures (audit, patterns, batch, transaction)

Purpose: Migrate medium-complexity test files and consolidate reusable local fixtures into conftest.py. The audit_utils and transaction_management files have sample_phenopacket fixtures that should be shared.

Output: 5 test files with modernized naming, reusable fixtures consolidated in conftest.py.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-RESEARCH.md
@.planning/phases/03-backend-test-modernization/03-01-SUMMARY.md
@backend/tests/conftest.py
@backend/tests/test_audit_utils.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Consolidate reusable fixtures into conftest.py</name>
  <files>
    backend/tests/conftest.py
    backend/tests/test_audit_utils.py
    backend/tests/test_transaction_management.py
  </files>
  <action>
Move sample phenopacket fixtures from test_audit_utils.py and test_transaction_management.py to conftest.py:

**From test_audit_utils.py (lines 23-73):**
```python
@pytest.fixture
def fixture_sample_phenopacket_minimal() -> Dict[str, Any]:
    """Minimal phenopacket for testing."""
    return {
        "id": "phenopacket:HNF1B:001",
        "subject": {"id": "patient-001", "sex": "MALE"},
        "phenotypicFeatures": [],
        "interpretations": [],
        "metaData": {
            "created": "2025-01-01T00:00:00Z",
            "createdBy": "curator@example.com",
            "resources": [],
            "phenopacketSchemaVersion": "2.0.0",
        },
    }

@pytest.fixture
def fixture_sample_phenopacket_with_data() -> Dict[str, Any]:
    """Phenopacket with phenotypes and variants for testing."""
    # ... full implementation from test_audit_utils.py
```

**From test_transaction_management.py:**
```python
@pytest.fixture
def fixture_valid_phenopacket_data():
    """Valid phenopacket data for testing."""

@pytest.fixture
def fixture_invalid_phenopacket_data():
    """Invalid phenopacket data for testing."""
```

Add these to conftest.py after the existing fixtures. Remove the local definitions from the original test files.

Add backward-compat aliases for the new fixtures:
```python
sample_phenopacket_minimal = fixture_sample_phenopacket_minimal
sample_phenopacket_with_data = fixture_sample_phenopacket_with_data
valid_phenopacket_data = fixture_valid_phenopacket_data
invalid_phenopacket_data = fixture_invalid_phenopacket_data
```
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
# Check fixtures moved to conftest
grep "fixture_sample_phenopacket" tests/conftest.py
# Check removed from audit_utils
grep "@pytest.fixture" tests/test_audit_utils.py | wc -l
# Should be 0 or only file-specific fixtures
```
  </verify>
  <done>Reusable phenopacket fixtures consolidated in conftest.py with fixture_ prefix, backward-compat aliases added, original definitions removed from test files</done>
</task>

<task type="auto">
  <name>Task 2: Migrate test_audit_utils.py and test_audit_logging.py naming</name>
  <files>
    backend/tests/test_audit_utils.py
    backend/tests/test_audit_logging.py
  </files>
  <action>
**test_audit_utils.py** - Rename all tests following pattern:

Class TestGenerateJsonPatch:
- `test_no_changes` -> `test_audit_json_patch_identical_inputs_returns_empty`
- `test_simple_field_change` -> `test_audit_json_patch_field_change_returns_replace_op`
- Similar pattern for all ~20 tests

Class TestComparePhenopackets:
- `test_identical` -> `test_audit_compare_identical_returns_no_changes`
- etc.

Class TestCreateAuditEntry:
- `test_create_audit_create_action` -> `test_audit_entry_create_action_records_change`
- etc.

Update fixture references to use `fixture_` prefix:
- `sample_phenopacket_minimal` -> `fixture_sample_phenopacket_minimal`
- `sample_phenopacket_with_data` -> `fixture_sample_phenopacket_with_data`
- `db_session` -> `fixture_db_session`

**test_audit_logging.py** - Rename all tests:
- Review each test and rename following `test_audit_<feature>_<scenario>_<expected>` pattern
- Update fixture references to use `fixture_` prefix
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_audit_utils.py tests/test_audit_logging.py -v 2>&1 | tail -25
```
  </verify>
  <done>Audit test files migrated with new naming conventions, using fixture_ prefix fixtures, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Migrate test_patterns.py, test_batch_endpoints.py, test_transaction_management.py</name>
  <files>
    backend/tests/test_patterns.py
    backend/tests/test_batch_endpoints.py
    backend/tests/test_transaction_management.py
  </files>
  <action>
**test_patterns.py** - Rename tests:
- `test_hgvs_c_pattern_valid` -> `test_patterns_hgvs_c_valid_input_matches`
- `test_hgvs_c_pattern_invalid` -> `test_patterns_hgvs_c_invalid_input_no_match`
- Similar for all pattern tests (hgvs_p, genomic, rsid, etc.)
- Keep class organization if present

**test_batch_endpoints.py** - Rename tests:
- `test_batch_create_phenopackets` -> `test_batch_create_valid_phenopackets_returns_201`
- `test_batch_update_phenopackets` -> `test_batch_update_existing_phenopackets_succeeds`
- Similar for all batch endpoint tests
- Update fixture references to use `fixture_` prefix

**test_transaction_management.py** - Rename tests:
- `test_transaction_commit` -> `test_transaction_commit_valid_data_persists`
- `test_transaction_rollback` -> `test_transaction_rollback_invalid_data_reverts`
- Similar for all transaction tests
- Update fixture references to use `fixture_` prefix (already consolidated in Task 1)

Run tests after each file modification to catch issues early.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_patterns.py tests/test_batch_endpoints.py tests/test_transaction_management.py -v 2>&1 | tail -25
```
  </verify>
  <done>3 additional test files migrated with new naming conventions, all tests passing</done>
</task>

</tasks>

<verification>
- [ ] `grep "fixture_sample_phenopacket" backend/tests/conftest.py` shows 2+ fixtures
- [ ] `grep "test_audit_" backend/tests/test_audit_utils.py | wc -l` shows 20+ matches
- [ ] `grep "test_patterns_" backend/tests/test_patterns.py | wc -l` shows matches
- [ ] `grep "test_batch_" backend/tests/test_batch_endpoints.py | wc -l` shows matches
- [ ] `cd backend && uv run pytest tests/test_audit_*.py tests/test_patterns.py tests/test_batch_endpoints.py tests/test_transaction_management.py -q` all pass
</verification>

<success_criteria>
1. Reusable fixtures (sample_phenopacket_*) consolidated in conftest.py
2. All 5 test files use `test_<feature>_<scenario>_<expected>` naming
3. All migrated tests use `fixture_` prefix fixtures
4. All migrated tests pass
5. No regressions in other tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-03-SUMMARY.md`
</output>
