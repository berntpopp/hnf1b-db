---
phase: 03-backend-test-modernization
plan: 06
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - backend/tests/test_classification_validation.py
  - backend/tests/test_comparisons.py
  - backend/tests/test_phenopacket_curation.py
  - backend/tests/test_survival_analysis.py
  - backend/tests/test_survival_protein_domain.py
  - backend/tests/test_jsonb_indexes.py
  - backend/tests/test_admin_sync_endpoints.py
  - backend/tests/test_direct_phenopackets_migration.py
autonomous: true

must_haves:
  truths:
    - "All test functions follow test_<feature>_<scenario>_<expected> naming"
    - "Fixtures use fixture_ prefix"
    - "All migrated tests pass"
  artifacts:
    - path: "backend/tests/test_classification_validation.py"
      provides: "Renamed classification tests"
      contains: "test_classification_"
    - path: "backend/tests/test_survival_analysis.py"
      provides: "Renamed survival tests"
      contains: "test_survival_"
  key_links:
    - from: "backend/tests/test_*.py"
      to: "backend/tests/conftest.py"
      via: "shared fixtures"
      pattern: "fixture_"
---

<objective>
Migrate test naming in Batch 5: Remaining test files (classification, comparisons, survival, migration)

Purpose: Complete the test migration by renaming the remaining test files. This includes complex domain logic tests (classification, comparisons, survival analysis) and infrastructure tests (indexes, admin, migration).

Output: 8 remaining test files with modernized naming conventions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-backend-test-modernization/03-CONTEXT.md
@.planning/phases/03-backend-test-modernization/03-RESEARCH.md
@.planning/phases/03-backend-test-modernization/03-01-SUMMARY.md
@backend/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_classification_validation.py and test_comparisons.py</name>
  <files>
    backend/tests/test_classification_validation.py
    backend/tests/test_comparisons.py
  </files>
  <action>
**test_classification_validation.py** - Rename tests (~50+ tests):
- `test_valid_acmg_classification` -> `test_classification_acmg_valid_value_passes`
- `test_invalid_acmg_classification` -> `test_classification_acmg_invalid_value_fails`
- `test_variant_effect_classification` -> `test_classification_variant_effect_maps_correctly`
- Similar for all classification tests

**test_comparisons.py** (~100+ tests, largest file after variant_validator):
- `test_phenopacket_comparison` -> `test_comparison_phenopacket_diff_detects_changes`
- `test_variant_comparison` -> `test_comparison_variant_diff_detects_changes`
- `test_phenotype_comparison` -> `test_comparison_phenotype_diff_detects_changes`
- Similar for all comparison tests

These files may have complex local fixtures for test data - keep those local but use `fixture_` prefix if they're pytest fixtures.

Update all shared fixture references to use `fixture_` prefix.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_classification_validation.py tests/test_comparisons.py -v 2>&1 | tail -30
```
  </verify>
  <done>Classification and comparison test files migrated with new naming, all tests passing</done>
</task>

<task type="auto">
  <name>Task 2: Migrate survival analysis and phenopacket curation tests</name>
  <files>
    backend/tests/test_survival_analysis.py
    backend/tests/test_survival_protein_domain.py
    backend/tests/test_phenopacket_curation.py
  </files>
  <action>
**test_survival_analysis.py** - Rename tests:
- `test_kaplan_meier_calculation` -> `test_survival_kaplan_meier_calculation_returns_curve`
- `test_survival_data_extraction` -> `test_survival_data_extraction_parses_phenopackets`
- `test_survival_endpoint` -> `test_survival_api_endpoint_returns_200`
- Similar for all survival tests

**test_survival_protein_domain.py** - Rename tests:
- `test_protein_domain_analysis` -> `test_survival_protein_domain_analysis_groups_correctly`
- `test_protein_domain_endpoint` -> `test_survival_protein_domain_api_returns_data`
- Similar for all protein domain tests

**test_phenopacket_curation.py** - Rename tests:
- `test_create_phenopacket` -> `test_curation_create_phenopacket_returns_201`
- `test_update_phenopacket` -> `test_curation_update_phenopacket_persists_changes`
- `test_delete_phenopacket` -> `test_curation_delete_phenopacket_removes_record`
- Similar for all curation tests

Update all fixture references to use `fixture_` prefix.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_survival_analysis.py tests/test_survival_protein_domain.py tests/test_phenopacket_curation.py -v 2>&1 | tail -25
```
  </verify>
  <done>Survival and curation test files migrated with new naming, all tests passing</done>
</task>

<task type="auto">
  <name>Task 3: Migrate infrastructure tests (indexes, admin, migration)</name>
  <files>
    backend/tests/test_jsonb_indexes.py
    backend/tests/test_admin_sync_endpoints.py
    backend/tests/test_direct_phenopackets_migration.py
  </files>
  <action>
**test_jsonb_indexes.py** - Rename tests:
- `test_gin_index_exists` -> `test_index_jsonb_gin_exists_on_phenopackets`
- `test_gin_index_query_plan` -> `test_index_jsonb_gin_query_plan_uses_index`
- `test_btree_index_exists` -> `test_index_btree_exists_on_created_at`
- Similar for all index tests

**test_admin_sync_endpoints.py** - Rename tests:
- `test_sync_ontologies` -> `test_admin_sync_ontologies_endpoint_returns_200`
- `test_sync_publications` -> `test_admin_sync_publications_endpoint_returns_200`
- Similar for all admin sync tests

**test_direct_phenopackets_migration.py** - Rename tests:
- `test_migration_basic` -> `test_migration_direct_basic_import_succeeds`
- `test_migration_with_variants` -> `test_migration_direct_with_variants_parses_correctly`
- `test_migration_validation` -> `test_migration_direct_validation_catches_errors`
- Similar for all migration tests

Update all fixture references to use `fixture_` prefix.
  </action>
  <verify>
```bash
cd /home/bernt-popp/development/hnf1b-db/backend
uv run pytest tests/test_jsonb_indexes.py tests/test_admin_sync_endpoints.py tests/test_direct_phenopackets_migration.py -v 2>&1 | tail -25
```
  </verify>
  <done>Infrastructure test files migrated with new naming, all tests passing</done>
</task>

</tasks>

<verification>
- [ ] `grep "test_classification_" backend/tests/test_classification_validation.py | wc -l` shows 50+ matches
- [ ] `grep "test_comparison_" backend/tests/test_comparisons.py | wc -l` shows 100+ matches
- [ ] `grep "test_survival_" backend/tests/test_survival_*.py | wc -l` shows substantial matches
- [ ] `grep "test_curation_" backend/tests/test_phenopacket_curation.py | wc -l` shows matches
- [ ] `cd backend && uv run pytest tests/test_classification_validation.py tests/test_comparisons.py tests/test_survival_*.py tests/test_phenopacket_curation.py tests/test_jsonb_indexes.py tests/test_admin_sync_endpoints.py tests/test_direct_phenopackets_migration.py -q` all pass
</verification>

<success_criteria>
1. All 8 test files use `test_<feature>_<scenario>_<expected>` naming
2. All files use `fixture_` prefix fixtures
3. All migrated tests pass
4. No regressions in other tests
</success_criteria>

<output>
After completion, create `.planning/phases/03-backend-test-modernization/03-06-SUMMARY.md`
</output>
