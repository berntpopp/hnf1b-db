# docker-compose.dev.yml
# Development overlay - use with base compose file
#
# Usage:
#   docker compose -f docker-compose.npm.yml -f docker-compose.dev.yml --env-file .env.docker up
#
# This overlay:
#   - Exposes ports for local access
#   - Mounts source code for hot reload
#   - Overrides NPM network to be local (non-external)
#   - Sets development environment variables

services:
  hnf1b_api:
    build:
      context: ./backend
      dockerfile: Dockerfile  # Use existing dev Dockerfile
    user: root  # Allow hot reload file watching
    read_only: false
    environment:
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      CORS_ORIGINS: "http://localhost:5173,http://localhost:8080,http://localhost:3000"
      ENABLE_DATA_IMPORT: ${ENABLE_DATA_IMPORT:-false}
    volumes:
      - ./backend/app:/app/app:ro
      - ./backend/migration:/app/migration:ro
    ports:
      - "${API_PORT_HOST:-8000}:8000"
    # Override healthcheck for dev (existing Dockerfile doesn't have curl)
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health')\""]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  hnf1b_frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile  # Use existing dev Dockerfile
      args:
        VITE_API_URL: http://localhost:${API_PORT_HOST:-8000}/api/v2
    user: root
    read_only: false
    # Override tmpfs without uid:gid restrictions for dev (regular nginx, not nginx-unprivileged)
    tmpfs: !override
      - /var/cache/nginx:size=50M,mode=0755
      - /var/run:size=10M,mode=0755
      - /tmp:size=10M,mode=1777
    # Add back capabilities needed for regular nginx entrypoint
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    ports:
      - "${FRONTEND_PORT_HOST:-3000}:80"
    # Override healthcheck for dev (existing Dockerfile uses port 80, not 8080)
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:80/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

  hnf1b_db:
    user: root  # Allow file access in dev mode
    ports:
      - "${DB_PORT_HOST:-5433}:5432"

  hnf1b_cache:
    user: root  # Allow file access in dev mode
    ports:
      - "${REDIS_PORT_HOST:-6380}:6379"

networks:
  npm_proxy_network:
    external: false
    name: hnf1b_dev_network
