# docker-compose.npm.yml
# HNF1B Database - Nginx Proxy Manager (NPM) Production Overlay
#
# Usage:
#   docker compose -f docker/docker-compose.yml -f docker/docker-compose.npm.yml --env-file .env.docker up -d --build
#
# This overlay:
# - Removes direct port exposure (NPM handles routing)
# - Connects to external NPM network for reverse proxy
# - Adds production security hardening
# - Uses production Dockerfiles
#
# NPM Configuration:
# - Create proxy host for hnf1b.org → hnf1b_frontend:80
# - Create proxy host for api.hnf1b.org → hnf1b_api:8000
# - Enable SSL with Let's Encrypt for both
#
# Prerequisites:
# 1. Create .env.docker from .env.docker.example with production values
# 2. NPM network must exist: docker network create npm_default
#
# Note: This overlay uses the same project name as the base compose file (hnf1b-db)
# to properly merge configurations. Container names are explicitly set to *_npm
# variants for clarity in production environments.

services:
  # ============================================
  # PostgreSQL Database (Production)
  # ============================================
  hnf1b_db:
    # PRODUCTION: No exposed ports - internal only
    ports: []

    # SECURITY: Require password
    environment:
      POSTGRES_USER: ${POSTGRES_USER:?POSTGRES_USER required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD required}
      POSTGRES_DB: ${POSTGRES_DB:-hnf1b_phenopackets}

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    # SECURITY: Drop capabilities
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true

  # ============================================
  # Redis Cache (Production)
  # ============================================
  hnf1b_cache:
    # PRODUCTION: No exposed ports - internal only
    ports: []

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

    # SECURITY: Drop capabilities
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    security_opt:
      - no-new-privileges:true

  # ============================================
  # FastAPI Backend (Production)
  # ============================================
  hnf1b_api:
    build:
      context: ../backend
      dockerfile: Dockerfile.prod
      args:
        BUILDKIT_INLINE_CACHE: 1

    # PRODUCTION: No exposed ports - NPM handles routing
    ports: []

    # Override container name for production
    container_name: hnf1b_api_npm

    # SECURITY: Run as non-root
    user: "10001:10001"

    # SECURITY: Read-only filesystem
    read_only: true
    tmpfs:
      - /tmp:uid=10001,gid=10001,size=100M,mode=1777

    # Production environment
    environment:
      DATABASE_URL: postgresql+asyncpg://${POSTGRES_USER}:${POSTGRES_PASSWORD}@hnf1b_db:5432/${POSTGRES_DB:-hnf1b_phenopackets}
      REDIS_URL: redis://hnf1b_cache:6379/0
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET required}
      DEBUG: "false"
      LOG_LEVEL: ${LOG_LEVEL_API:-INFO}
      CORS_ORIGINS: ${CORS_ORIGINS:-https://hnf1b.org,https://www.hnf1b.org}

    # Connect to NPM network
    networks:
      - hnf1b_internal
      - npm_proxy_network

    # Production healthcheck with curl
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G

    # SECURITY: Drop all capabilities
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  # ============================================
  # Vue.js Frontend (Production)
  # ============================================
  hnf1b_frontend:
    build:
      context: ../frontend
      dockerfile: Dockerfile.prod
      args:
        VITE_API_URL: ${VITE_API_URL:-https://api.hnf1b.org/api/v2}
        BUILDKIT_INLINE_CACHE: 1

    # PRODUCTION: No exposed ports - NPM handles routing
    ports: []

    # Override container name for production
    container_name: hnf1b_frontend_npm

    # SECURITY: Run as nginx user (101:101)
    user: "101:101"

    # SECURITY: Read-only filesystem
    read_only: true
    tmpfs:
      - /var/cache/nginx:uid=101,gid=101,size=50M,mode=0755
      - /var/run:uid=101,gid=101,size=10M,mode=0755
      - /tmp:uid=101,gid=101,size=10M,mode=1777

    # Connect to NPM network
    networks:
      - hnf1b_internal
      - npm_proxy_network

    # Production healthcheck
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:8080/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # SECURITY: Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

    # SECURITY: Drop all capabilities
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

# ============================================
# Networks
# ============================================
networks:
  npm_proxy_network:
    external: true
    name: ${NPM_SHARED_NETWORK_NAME:-npm_default}

# ============================================
# Volumes (inherit from base)
# ============================================
volumes:
  hnf1b_postgres_data:
    name: hnf1b_postgres_data
  hnf1b_redis_data:
    name: hnf1b_redis_data
